pipeline {
    agent any

    environment {
        CLUSTER_NAME = 'k8s-terraform'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Environment Check') {
            steps {
                bat 'docker --version || echo Docker not found'
                bat 'kubectl version --client || echo kubectl not found'
                bat 'terraform version || echo Terraform not found'
                bat 'kind version || echo Kind not found'
            }
        }

        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat 'terraform init -input=false'
                    bat 'terraform validate'
                }
            }
        }

        stage('Setup Kind Cluster') {
            steps {
                script {
                    echo "========================================"
                    echo "Checking Kind cluster status..."
                    echo "========================================"

                    def clusterExists = bat(script: "kind get clusters | findstr ${env.CLUSTER_NAME}", returnStatus: true) == 0

                    if (!clusterExists) {
                        bat "kind create cluster --name ${env.CLUSTER_NAME}"
                    }

                    // Attendre que le cluster soit prÃªt
                    timeout(time: 2, unit: 'MINUTES') {
                        waitUntil {
                            def ready = bat(script: "kubectl get nodes --context kind-${env.CLUSTER_NAME} --no-headers | findstr Ready", returnStatus: true) == 0
                            return ready
                        }
                    }

                    // Afficher les infos du cluster
                    bat "kubectl cluster-info --context kind-${env.CLUSTER_NAME}"
                }
            }
        }

        stage('Build Backend Image') {
            steps {
                bat 'docker build -f backend/Dockerfile -t transport-backend:latest -t transport-backend:13 backend'
            }
        }

        stage('Build Frontend Image') {
            steps {
                bat 'docker build -f frontend/Dockerfile -t transport-frontend:latest -t transport-frontend:13 frontend'
            }
        }

        stage('Load Images to Kind') {
            steps {
                bat "kind load docker-image transport-backend:latest --name ${env.CLUSTER_NAME}"
                bat "kind load docker-image transport-frontend:latest --name ${env.CLUSTER_NAME}"
            }
        }

        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    // S'assurer que le contexte kubectl est correct
                    bat "kubectl config use-context kind-${env.CLUSTER_NAME}"
                    bat "kubectl get nodes"

                    // Appliquer Terraform
                    bat "terraform apply -auto-approve"
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline completed."
        }
        failure {
            echo "Pipeline failed. You can clean up with: kind delete cluster --name ${env.CLUSTER_NAME}"
        }
    }
}
