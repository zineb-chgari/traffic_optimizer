pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = '' // si tu utilises Docker Hub, mets ton login ici
        COMMIT_SHORT = ''
    }

    stages {
        stage('Checkout SCM') {
            steps {
                echo "[INFO] Checking out code from Git"
                bat '"C:\\Program Files\\Git\\cmd\\git.exe" --version'
                bat '"C:\\Program Files\\Git\\cmd\\git.exe" clone https://github.com/zineb-chgari/traffic_optimizer.git . || exit 0'
                bat 'set COMMIT_SHORT="C:\\Program Files\\Git\\cmd\\git.exe" rev-parse --short HEAD'
                echo "Current commit: %COMMIT_SHORT%"
            }
        }

        stage('Check Git & Docker') {
            steps {
                echo "[INFO] Checking Git & Docker versions"
                bat '"C:\\Program Files\\Git\\cmd\\git.exe" --version'
                bat '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe" --version'
            }
        }

        stage('Build Frontend Docker') {
            steps {
                echo "[INFO] Building frontend Docker image..."
                bat '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe" build -f frontend\\Dockerfile -t traffic_front .'
            }
        }

        stage('Build Backend Docker') {
            steps {
                echo "[INFO] Building backend Docker image..."
                bat '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe" build -f backend\\Dockerfile -t traffic_back .'
            }
        }

        stage('Deploy with Ansible (Placeholder)') {
            steps {
                echo "[INFO] Deploying with Ansible (to configure later)..."
                // bat 'ansible-playbook deploy.yml' // à configurer
            }
        }

        stage('Provision Infra with Terraform (Placeholder)') {
            steps {
                echo "[INFO] Provisioning infrastructure with Terraform (to configure later)..."
                // bat 'terraform init && terraform apply -auto-approve' // à configurer
            }
        }

        stage('Deploy to Kubernetes (Placeholder)') {
            steps {
                echo "[INFO] Deploying to Kubernetes (to configure later)..."
                // bat 'kubectl apply -f k8s/' // à configurer
            }
        }
    }

    post {
        always {
            echo "[INFO] Cleaning up Docker..."
            bat '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe" system prune -f || exit 0'
        }

        success {
            echo "[SUCCESS] Pipeline finished successfully!"
        }

        failure {
            echo "[ERROR] Pipeline failed!"
        }
    }
}
