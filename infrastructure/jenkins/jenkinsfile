pipeline {
    agent any

    environment {
        // Variables Docker
        DOCKER_PATH = '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe"'
        FRONT_IMAGE = "traffic_front"
        BACK_IMAGE = "traffic_back"
    }

    stages {
        stage('Checkout SCM') {
            steps {
                echo "[INFO] Checkout code from Git"
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[url: 'https://github.com/zineb-chgari/traffic_optimizer.git']]
                ])
                script {
                    GIT_COMMIT = bat(script: '"C:\\Program Files\\Git\\cmd\\git.exe" rev-parse --short HEAD', returnStdout: true).trim()
                    echo "Current commit: ${GIT_COMMIT}"
                }
            }
        }

        stage('Check Git & Docker') {
            steps {
                bat '"C:\\Program Files\\Git\\cmd\\git.exe" --version'
                bat "${DOCKER_PATH} --version"
            }
        }

        stage('Build Frontend Docker') {
            steps {
                echo "[INFO] Building frontend Docker image..."
                bat "${DOCKER_PATH} build -f frontend/Dockerfile -t %FRONT_IMAGE%:%GIT_COMMIT% frontend"
            }
        }

        stage('Build Backend Docker') {
            steps {
                echo "[INFO] Building backend Docker image..."
                bat "${DOCKER_PATH} build -f backend/Dockerfile -t %BACK_IMAGE%:%GIT_COMMIT% backend"
            }
        }

        stage('Optional: Push Docker Images') {
            steps {
                echo "[INFO] Push Docker images (if needed)"
                // DÃ©commente si tu veux pousser sur un registry
                // bat "${DOCKER_PATH} tag %FRONT_IMAGE%:%GIT_COMMIT% myregistry/traffic_front:%GIT_COMMIT%"
                // bat "${DOCKER_PATH} push myregistry/traffic_front:%GIT_COMMIT%"
            }
        }
    }

    post {
        always {
            echo "[INFO] Cleaning up Docker..."
            bat "${DOCKER_PATH} system prune -f || exit 0"
        }
        success {
            echo "[SUCCESS] Pipeline finished successfully!"
        }
        failure {
            echo "[ERROR] Pipeline failed!"
        }
    }
}
