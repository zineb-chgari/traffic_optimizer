pipeline {
    agent {
        label 'trafic'
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    environment {
        TOMTOM_API_KEY = credentials('tomtom-api-key') ?: 'Cjx7i2N9ESmF9Sq8Bw6QtZ4FRJkCQMLy'
        OPENCAGE_API_KEY = credentials('opencage-api-key') ?: '464eb4ad7e734a768928fd696b968ee4'
        ORS_API_KEY = credentials('ors-api-key') ?: 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjIwNjAxYzVlZmFlNjQ1OGZiOTY3ODUxNDg3NTY2MjBlIiwiaCI6Im11cm11cjY0In0='
        BUILD_NUMBER_PADDED = "${BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout SCM') {
            steps {
                script {
                    echo '=========================================='
                    echo '=== CHECKOUT PHASE ==='
                    echo '=========================================='
                    
                    bat '''
                        echo Verifying Git installation...
                        if exist "C:\\Program Files\\Git\\bin\\git.exe" (
                            echo Git found at: C:\\Program Files\\Git\\bin\\git.exe
                            "C:\\Program Files\\Git\\bin\\git.exe" --version
                        ) else (
                            echo Git not found at standard location!
                            echo Searching for git.exe...
                            where git.exe
                        )
                    '''
                    
                    echo 'Using Jenkins built-in checkout (already completed)'
                    echo 'Code checked out successfully!'
                    
                    bat '''
                        echo ==========================================
                        echo === VERIFYING CHECKOUT ===
                        echo ==========================================
                        echo Files in workspace:
                        dir /b
                        echo.
                        
                        if exist "backend" (echo backend directory found) else (
                            echo backend directory NOT found!
                            exit /b 1
                        )
                        if exist "frontend" (echo frontend directory found) else (
                            echo frontend directory NOT found!
                            exit /b 1
                        )
                        if exist "infrastructure" (echo infrastructure directory found) else (
                            echo infrastructure directory NOT found!
                            exit /b 1
                        )
                        
                        echo.
                        echo All required directories verified!
                    '''
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    try {
                        withCredentials([
                            string(credentialsId: 'tomtom-api-key', variable: 'TOMTOM_API_KEY'),
                            string(credentialsId: 'opencage-api-key', variable: 'OPENCAGE_API_KEY'),
                            string(credentialsId: 'ors-api-key', variable: 'ORS_API_KEY')
                        ]) {
                            echo 'API Keys loaded from Jenkins credentials'
                        }
                    } catch (Exception e) {
                        echo 'WARNING: Jenkins credentials not found, using hardcoded API keys from .env'
                    }
                    echo 'API Keys configured successfully'
                }
            }
        }
        
        stage('Environment Check') {
            steps {
                script {
                    bat '''
                        echo ==========================================
                        echo === ENVIRONMENT CHECK ===
                        echo ==========================================
                        echo PATH: %PATH%
                        echo.
                        
                        echo Checking tools...
                        docker --version
                        kubectl version --client
                        terraform version
                        kind version
                        echo.
                        
                        echo Checking API Keys...
                        if "%TOMTOM_API_KEY%"=="YOUR_TOMTOM_API_KEY_HERE" (echo TomTom API Key not configured!) else (echo TomTom API Key configured)
                        if "%OPENCAGE_API_KEY%"=="YOUR_OPENCAGE_API_KEY_HERE" (echo OpenCage API Key not configured!) else (echo OpenCage API Key configured)
                        if "%ORS_API_KEY%"=="YOUR_ORS_API_KEY_HERE" (echo ORS API Key not configured!) else (echo ORS API Key configured)
                        echo.
                        
                        echo All tools found successfully!
                    '''
                }
            }
        }
        
        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat '''
                        terraform init -input=false
                        terraform validate
                    '''
                }
            }
        }
        
        stage('Pull Base Images') {
            steps {
                script {
                    retry(2) {
                        bat '''
                            echo ==========================================
                            echo === PULLING BASE IMAGES ===
                            echo ==========================================
                            echo Pulling node:20-alpine...
                            docker pull node:20-alpine
                            echo.
                            
                            echo Pulling nginx:alpine...
                            docker pull nginx:alpine
                            echo.
                            
                            echo Pulling Redis image with amd64 platform...
                            docker pull --platform linux/amd64 redis:7-alpine
                            echo.
                            
                            echo Verifying pulled images...
                            docker images | findstr "node.*20-alpine"
                            docker images | findstr "nginx.*alpine"
                            docker images | findstr "redis.*7-alpine"
                            echo.
                            
                            echo All base images pulled successfully!
                        '''
                    }
                }
            }
        }
        
        stage('Build Backend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 10, unit: 'MINUTES') {
                            bat """
                                echo ==========================================
                                echo === BUILDING BACKEND IMAGE ===
                                echo ==========================================
                                docker build -f backend\\Dockerfile ^
                                    --build-arg TOMTOM_API_KEY=${env.TOMTOM_API_KEY} ^
                                    --build-arg OPENCAGE_API_KEY=${env.OPENCAGE_API_KEY} ^
                                    --build-arg ORS_API_KEY=${env.ORS_API_KEY} ^
                                    -t transport-backend:latest ^
                                    -t transport-backend:${env.BUILD_NUMBER_PADDED} ^
                                    backend
                                echo.
                                echo Backend image built successfully!
                            """
                        }
                    }
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 20, unit: 'MINUTES') {
                            bat """
                                echo ==========================================
                                echo === BUILDING FRONTEND IMAGE ===
                                echo ==========================================
                                docker build -f frontend\\Dockerfile ^
                                    --build-arg NODE_OPTIONS=--max-old-space-size=4096 ^
                                    --build-arg TOMTOM_API_KEY=${env.TOMTOM_API_KEY} ^
                                    -t transport-frontend:latest ^
                                    -t transport-frontend:${env.BUILD_NUMBER_PADDED} ^
                                    frontend
                                echo.
                                echo Frontend image built successfully!
                            """
                        }
                    }
                }
            }
        }
        
        stage('Cleanup Old Cluster') {
            steps {
                bat '''
                    echo ==========================================
                    echo === CLEANING UP OLD CLUSTER ===
                    echo ==========================================
                    echo Deleting existing cluster if present...
                    kind delete cluster --name k8s-terraform 2>nul || echo No existing cluster to delete
                    
                    echo Waiting for cleanup to complete...
                    ping 127.0.0.1 -n 3 >nul
                    echo Cleanup complete!
                '''
            }
        }
        
        stage('Setup Kind Cluster - 3 Nodes') {
            steps {
                bat '''
                    echo ==========================================
                    echo === CREATING KIND CLUSTER WITH 3 NODES ===
                    echo ==========================================
                    
                    echo Verifying kind-config.yaml exists...
                    if exist "infrastructure\\kind-config.yaml" (
                        echo Configuration file found!
                        echo.
                        echo Configuration content:
                        type infrastructure\\kind-config.yaml
                    ) else (
                        echo ERROR: kind-config.yaml not found in infrastructure directory!
                        exit /b 1
                    )
                    
                    echo.
                    echo Creating fresh cluster k8s-terraform with 3 nodes...
                    kind create cluster --name k8s-terraform --config infrastructure\\kind-config.yaml
                    
                    echo.
                    echo Waiting for all nodes to be ready...
                    timeout /t 10 /nobreak >nul
                    
                    :wait_all_nodes
                    kubectl get nodes 2>nul | find /c "Ready" > node_count.txt
                    set /p NODE_COUNT=<node_count.txt
                    del node_count.txt
                    
                    if %NODE_COUNT% LSS 3 (
                        echo Only %NODE_COUNT% nodes ready, waiting for all 3 nodes...
                        ping 127.0.0.1 -n 6 >nul
                        goto wait_all_nodes
                    )
                    
                    echo.
                    echo === ALL 3 NODES ARE READY ===
                    kubectl get nodes -o wide
                    
                    echo.
                    echo Waiting for system pods...
                    kubectl wait --for=condition=ready pod -l k8s-app=kube-dns -n kube-system --timeout=180s
                    
                    echo.
                    echo === CLUSTER IS FULLY OPERATIONAL ===
                    echo Nodes:
                    kubectl get nodes
                    echo.
                    echo System Pods:
                    kubectl get pods -n kube-system -o wide
                '''
            }
        }
        
        stage('Verify Cluster Connection') {
            steps {
                bat '''
                    echo ==========================================
                    echo === VERIFYING CLUSTER CONNECTION ===
                    echo ==========================================
                    echo Cluster Info:
                    kubectl cluster-info
                    echo.
                    
                    echo Nodes (should be 3):
                    kubectl get nodes -o wide
                    echo.
                    
                    echo Verifying node count...
                    kubectl get nodes --no-headers | find /c "Ready" > node_count.txt
                    set /p NODE_COUNT=<node_count.txt
                    del node_count.txt
                    
                    echo Total nodes ready: %NODE_COUNT%
                    if %NODE_COUNT% NEQ 3 (
                        echo WARNING: Expected 3 nodes but found %NODE_COUNT%!
                    ) else (
                        echo SUCCESS: All 3 nodes are ready!
                    )
                    echo.
                    
                    echo Namespaces:
                    kubectl get namespaces
                    echo.
                    
                    echo System Pods distribution across nodes:
                    kubectl get pods -n kube-system -o wide
                    echo.
                    
                    echo Cluster verification complete!
                '''
            }
        }
        
        stage('Load Images to Kind') {
            steps {
                bat '''
                    echo ==========================================
                    echo === LOADING IMAGES TO ALL KIND NODES ===
                    echo ==========================================
                    echo Loading backend image...
                    kind load docker-image transport-backend:latest --name k8s-terraform
                    if errorlevel 1 (
                        echo ERROR: Failed to load backend image!
                        exit /b 1
                    )
                    echo Backend image loaded successfully!
                    echo.
                    
                    echo Loading frontend image...
                    kind load docker-image transport-frontend:latest --name k8s-terraform
                    if errorlevel 1 (
                        echo ERROR: Failed to load frontend image!
                        exit /b 1
                    )
                    echo Frontend image loaded successfully!
                    echo.
                    
                    echo Loading Redis image with workaround...
                    docker save redis:7-alpine | docker exec -i k8s-terraform-control-plane ctr --namespace=k8s.io images import --all-platforms=false --base-name docker.io/library/redis:7-alpine -
                    if errorlevel 1 (
                        echo Trying alternative tar-based method...
                        docker save redis:7-alpine -o %TEMP%\\redis-temp.tar
                        docker cp %TEMP%\\redis-temp.tar k8s-terraform-control-plane:/tmp/redis.tar
                        docker exec k8s-terraform-control-plane ctr --namespace=k8s.io images import --all-platforms=false /tmp/redis.tar
                        docker exec k8s-terraform-control-plane rm /tmp/redis.tar
                        del %TEMP%\\redis-temp.tar
                        if errorlevel 1 (
                            echo ERROR: All methods failed to load Redis image!
                            exit /b 1
                        )
                    )
                    echo Redis image loaded successfully!
                    echo.
                    
                    echo === LOADING IMAGES TO WORKER NODES ===
                    for /f "tokens=1" %%n in ('kubectl get nodes --no-headers ^| findstr worker') do (
                        echo Loading images to %%n...
                        docker exec %%n crictl images || echo Images already loaded on %%n
                    )
                    echo.
                    
                    echo === VERIFYING LOADED IMAGES ON ALL NODES ===
                    for /f "tokens=1" %%n in ('kubectl get nodes --no-headers') do (
                        echo.
                        echo Images on node %%n:
                        docker exec %%n crictl images | findstr transport
                        docker exec %%n crictl images | findstr redis
                    )
                    echo.
                    
                    echo All images loaded and verified successfully on all nodes!
                '''
            }
        }
        
        stage('Pre-Deploy Diagnostics') {
            steps {
                bat '''
                    echo ==========================================
                    echo === PRE-DEPLOYMENT DIAGNOSTICS ===
                    echo ==========================================
                    echo Available images in Kind control-plane:
                    docker exec k8s-terraform-control-plane crictl images
                    echo.
                    
                    echo Cluster resources:
                    kubectl top nodes 2>nul || echo "Metrics server not available"
                    echo.
                    
                    echo Node details:
                    kubectl describe nodes | findstr "Allocatable"
                    echo.
                    
                    echo Current events:
                    kubectl get events --all-namespaces --sort-by=.metadata.creationTimestamp | findstr /V "Normal" || echo "No warning events"
                '''
            }
        }
        
        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    script {
                        bat """
                            echo ==========================================
                            echo === DEPLOYING WITH TERRAFORM ===
                            echo ==========================================
                            echo Setting Terraform variables...
                            set TF_VAR_tomtom_api_key=${env.TOMTOM_API_KEY}
                            set TF_VAR_opencage_api_key=${env.OPENCAGE_API_KEY}
                            set TF_VAR_ors_api_key=${env.ORS_API_KEY}
                            
                            echo Applying Terraform configuration...
                            terraform apply -auto-approve ^
                                -var="tomtom_api_key=${env.TOMTOM_API_KEY}" ^
                                -var="opencage_api_key=${env.OPENCAGE_API_KEY}" ^
                                -var="ors_api_key=${env.ORS_API_KEY}"
                            echo.
                            echo Terraform deployment complete!
                        """
                    }
                }
            }
        }
        
        stage('Wait for Deployments') {
            options {
                timeout(time: 10, unit: 'MINUTES')
            }
            steps {
                bat '''
                    echo ==========================================
                    echo === WAITING FOR DEPLOYMENTS ===
                    echo ==========================================
                    echo Waiting for Redis deployment...
                    kubectl rollout status deployment/redis --timeout=300s || (
                        echo WARNING: Redis deployment timeout!
                        kubectl get pods -l app=redis
                        kubectl describe pods -l app=redis
                    )
                    echo.
                    
                    echo Waiting for Backend deployment...
                    kubectl rollout status deployment/backend --timeout=300s || (
                        echo WARNING: Backend deployment timeout!
                        kubectl get pods -l app=backend
                        kubectl describe pods -l app=backend
                        echo.
                        echo === BACKEND POD LOGS ===
                        kubectl logs -l app=backend --tail=100 --all-containers=true || echo "Cannot fetch logs"
                    )
                    echo.
                    
                    echo Waiting for Frontend deployment...
                    kubectl rollout status deployment/frontend --timeout=300s || (
                        echo WARNING: Frontend deployment timeout!
                        kubectl get pods -l app=frontend
                        kubectl describe pods -l app=frontend
                    )
                    echo.
                    
                    echo === DEPLOYMENT STATUS ===
                    kubectl get deployments
                    kubectl get pods -o wide
                '''
            }
        }
        
        stage('Wait for Pods Ready') {
            options {
                timeout(time: 5, unit: 'MINUTES')
            }
            steps {
                bat '''
                    echo ==========================================
                    echo === WAITING FOR PODS TO BE READY ===
                    echo ==========================================
                    echo Waiting for Redis pod...
                    kubectl wait --for=condition=ready pod -l app=redis --timeout=180s || echo Redis pod not ready yet
                    echo.
                    
                    echo Waiting for Backend pods...
                    kubectl wait --for=condition=ready pod -l app=backend --timeout=180s || (
                        echo Backend pods not ready yet
                        echo.
                        echo === CHECKING BACKEND POD STATUS ===
                        kubectl get pods -l app=backend
                        echo.
                        echo === BACKEND POD EVENTS ===
                        kubectl get events --field-selector involvedObject.kind=Pod --sort-by=.metadata.creationTimestamp | findstr backend
                        echo.
                        echo === BACKEND POD LOGS ===
                        kubectl logs -l app=backend --tail=50 --all-containers=true || echo "Cannot fetch logs"
                    )
                    echo.
                    
                    echo Waiting for Frontend pods...
                    kubectl wait --for=condition=ready pod -l app=frontend --timeout=180s || echo Frontend pods not ready yet
                    echo.
                    
                    echo === CURRENT POD STATUS WITH NODE DISTRIBUTION ===
                    kubectl get pods -o wide
                    echo.
                    
                    echo === POD DISTRIBUTION PER NODE ===
                    for /f "tokens=1" %%n in ('kubectl get nodes --no-headers') do (
                        echo.
                        echo Pods on node %%n:
                        kubectl get pods -o wide | findstr %%n
                    )
                '''
            }
        }
        
        stage('Verify Deployment') {
            steps {
                bat '''
                    echo ==========================================
                    echo === DEPLOYMENT VERIFICATION ===
                    echo ==========================================
                    echo.
                    
                    echo === PODS STATUS WITH NODE DISTRIBUTION ===
                    kubectl get pods -o wide
                    echo.
                    
                    echo === SERVICES ===
                    kubectl get svc
                    echo.
                    
                    echo === DEPLOYMENTS ===
                    kubectl get deployment
                    echo.
                    
                    echo === ENDPOINTS ===
                    kubectl get endpoints
                    echo.
                    
                    echo === SECRETS ===
                    kubectl get secrets
                    echo.
                    
                    echo === POD DISTRIBUTION SUMMARY ===
                    for /f "tokens=1" %%n in ('kubectl get nodes --no-headers') do (
                        echo.
                        echo Node: %%n
                        kubectl get pods -o wide --no-headers | findstr %%n | find /c "Running" > pod_count.txt
                        set /p POD_COUNT=<pod_count.txt
                        del pod_count.txt
                        echo   Running pods: %POD_COUNT%
                        kubectl get pods -o wide --no-headers | findstr %%n
                    )
                    echo.
                    
                    echo ==========================================
                    echo === POD LOGS SUMMARY ===
                    echo ==========================================
                    echo.
                    
                    echo === Redis Logs (last 20 lines) ===
                    kubectl logs -l app=redis --tail=20 --all-containers=true 2>nul || echo No Redis logs available yet
                    echo.
                    
                    echo === Backend Logs (last 50 lines) ===
                    kubectl logs -l app=backend --tail=50 --all-containers=true 2>nul || echo No Backend logs available yet
                    echo.
                    
                    echo === Frontend Logs (last 20 lines) ===
                    kubectl logs -l app=frontend --tail=20 --all-containers=true 2>nul || echo No Frontend logs available yet
                    echo.
                    
                    echo ==========================================
                    echo === HEALTH CHECKS ===
                    echo ==========================================
                    echo Testing Redis connectivity...
                    kubectl exec deployment/redis -- redis-cli -a monsecret ping 2>nul || echo Redis not responding
                    echo.
                    
                    echo Testing Backend health endpoint...
                    kubectl exec deployment/backend -- wget -q -O- http://localhost:3000/health 2>nul || echo Backend health check failed
                    echo.
                    
                    echo Checking ALL API Keys in backend...
                    kubectl exec deployment/backend -- printenv | findstr API_KEY 2>nul || echo API key env var check failed
                '''
            }
        }
        
        stage('Final Status Report') {
            steps {
                bat '''
                    echo.
                    echo ==========================================
                    echo === FINAL DEPLOYMENT STATUS ===
                    echo ==========================================
                    echo.
                    
                    echo === 3-NODE CLUSTER STATUS ===
                    kubectl get nodes -o wide
                    echo.
                    
                    echo Verifying we have 3 nodes...
                    kubectl get nodes --no-headers | find /c "Ready" > node_count.txt
                    set /p NODE_COUNT=<node_count.txt
                    del node_count.txt
                    echo Total nodes: %NODE_COUNT%
                    if %NODE_COUNT% EQU 3 (
                        echo ✓ SUCCESS: All 3 nodes are operational!
                    ) else (
                        echo ✗ WARNING: Expected 3 nodes but found %NODE_COUNT%
                    )
                    echo.
                    
                    echo === PODS DISTRIBUTION ACROSS NODES ===
                    kubectl get pods -o wide
                    echo.
                    
                    echo === DETAILED NODE DISTRIBUTION ===
                    for /f "tokens=1" %%n in ('kubectl get nodes --no-headers') do (
                        echo.
                        echo ====================================
                        echo Node: %%n
                        echo ====================================
                        kubectl get pods -o wide --no-headers | findstr %%n
                    )
                    echo.
                    
                    echo === DEPLOYMENTS ===
                    kubectl get deployments
                    echo.
                    
                    echo === SERVICES ===
                    kubectl get svc
                    echo.
                    
                    echo === SYSTEM PODS (across all nodes) ===
                    kubectl get pods -n kube-system -o wide
                    echo.
                    
                    echo Recent events (errors only):
                    kubectl get events --all-namespaces --field-selector type!=Normal --sort-by=.metadata.creationTimestamp | findstr /V "LAST" || echo No error events found
                    echo.
                    echo ==========================================
                '''
            }
        }
        
        stage('Save Deployment Info') {
            steps {
                script {
                    bat '''
                        echo Saving deployment information...
                        kubectl get svc >deployment-services.txt 2>&1 || echo "Could not save services info"
                        kubectl get pods -o wide >deployment-pods.txt 2>&1 || echo "Could not save pods info"
                        kubectl get nodes -o wide >deployment-nodes.txt 2>&1 || echo "Could not save nodes info"
                        kubectl logs -l app=backend --tail=100 >backend-logs.txt 2>&1 || echo "Could not save backend logs"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'Pipeline execution completed - Cleaning up...'
                bat 'docker system prune -f || exit 0'
            }
        }
        success {
            script {
                echo ''
                echo '=========================================='
                echo 'PIPELINE SUCCEEDED'
                echo '=========================================='
                echo ''
                echo 'Your application has been successfully deployed on a 3-node cluster!'
                echo ''
                echo '=== CLUSTER INFORMATION ==='
                bat 'kubectl get nodes -o wide 2>nul || echo "Cluster info not available"'
                echo ''
                echo '=== POD DISTRIBUTION ==='
                bat 'kubectl get pods -o wide 2>nul || echo "Pod info not available"'
                echo ''
                echo 'To access the services, open a NEW terminal and run:'
                echo ''
                echo 'FOR FRONTEND:'
                echo '  kubectl port-forward service/frontend-service 8080:80'
                echo '  Then open: http://localhost:8080'
                echo ''
                echo 'FOR BACKEND:'
                echo '  kubectl port-forward service/backend-service 3000:3000'
                echo '  Then open: http://localhost:3000/health'
                echo ''
                echo '=========================================='
            }
        }
        failure {
            script {
                echo ''
                echo '=========================================='
                echo 'PIPELINE FAILED'
                echo '=========================================='
                echo ''
                echo 'Collecting diagnostics...'
                bat '''
                    echo === NODES ===
                    kubectl get nodes 2>nul || echo "Cannot get nodes"
                    echo.
                    echo === PODS ===
                    kubectl get pods --all-namespaces 2>nul || echo "Cannot get pods"
                    echo.
                    echo === RECENT EVENTS ===
                    kubectl get events --all-namespaces --sort-by=.metadata.creationTimestamp | findstr /V "Normal" 2>nul || echo "Cannot get events"
                '''
                echo ''
                echo 'Check the logs above for error details.'
                echo '=========================================='
            }
        }
    }
}