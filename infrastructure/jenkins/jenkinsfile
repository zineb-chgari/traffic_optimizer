pipeline {
    agent any

    environment {
        CLUSTER_NAME = "k8s-terraform"
        BACKEND_IMAGE = "transport-backend:latest"
        FRONTEND_IMAGE = "transport-frontend:latest"
        KUBECONFIG = "${env.WORKSPACE}\\.kube\\config"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Environment Check') {
            steps {
                bat 'docker --version || echo Docker not found'
                bat 'kubectl version --client || echo kubectl not found'
                bat 'terraform version || echo Terraform not found'
                bat 'kind version || echo Kind not found'
            }
        }

        stage('Clean Existing Kind Cluster') {
            steps {
                echo "Deleting existing Kind cluster (if any)..."
                bat "kind delete cluster --name %CLUSTER_NAME% || exit 0"
            }
        }

        stage('Build Docker Images') {
            steps {
                bat "docker build -f backend\\Dockerfile -t %BACKEND_IMAGE% backend"
                bat "docker build -f frontend\\Dockerfile -t %FRONTEND_IMAGE% frontend"
            }
        }

        stage('Create Kind Cluster') {
            steps {
                echo "Creating new Kind cluster..."
                bat """
                kind create cluster --name %CLUSTER_NAME%
                kubectl wait --for=condition=Ready pods --all -n kube-system --timeout=120s
                kubectl cluster-info
                """
            }
        }

        stage('Load Docker Images into Kind') {
            steps {
                bat "kind load docker-image %BACKEND_IMAGE% --name %CLUSTER_NAME%"
                bat "kind load docker-image %FRONTEND_IMAGE% --name %CLUSTER_NAME%"
            }
        }

        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure\\Terraform') {
                    bat """
                    set KUBECONFIG=%WORKSPACE%\\.kube\\config
                    terraform init -input=false
                    terraform validate
                    terraform apply -auto-approve
                    """
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                echo "Checking pods in default namespace..."
                bat "kubectl get pods -n default"
            }
        }
    }

    post {
        failure {
            echo "Pipeline failed. You can delete the cluster and retry:"
            echo "  kind delete cluster --name %CLUSTER_NAME%"
        }
    }
}
