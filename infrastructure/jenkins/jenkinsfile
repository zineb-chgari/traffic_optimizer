pipeline {
    agent any

    environment {
        // Remplace ces chemins par ceux oÃ¹ se trouvent kind.exe et kubectl.exe sur ton PC
        PATH = "C:\\Users\\pc\\Downloads\\devops_projet;%PATH%"
        DOCKER_REG = ''
        BACKEND_IMAGE = 'transport-backend'
        FRONTEND_IMAGE = 'transport-frontend'
        IMAGE_TAG = "${BUILD_NUMBER}"
        KUBECONFIG = "${WORKSPACE}\\.kube\\config"
    }

    stages {
        stage('Checkout SCM') {
            steps {
                echo '=== Checking out SCM ==='
                checkout scm
            }
        }

        stage('Setup Kind Cluster') {
            steps {
                echo '=== Setting up Kind Cluster ==='
                bat '''
                kind delete cluster --name k8s-terraform 2>nul || echo No previous cluster
                kubectl config delete-context kind-k8s-terraform 2>nul || echo No previous context
                kind create cluster --name k8s-terraform --wait 120s
                kind export kubeconfig --name k8s-terraform
                kubectl cluster-info --context kind-k8s-terraform
                '''
            }
        }

        stage('Build Docker Images') {
            steps {
                echo '=== Building Docker Images ==='
                bat '''
                docker build -t %BACKEND_IMAGE%:%IMAGE_TAG% ./backend
                docker build -t %FRONTEND_IMAGE%:%IMAGE_TAG% ./frontend
                '''
            }
        }

        stage('Push Docker Images (Optional)') {
            steps {
                echo '=== Pushing Docker Images ==='
                bat '''
                REM docker push %BACKEND_IMAGE%:%IMAGE_TAG%
                REM docker push %FRONTEND_IMAGE%:%IMAGE_TAG%
                '''
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                echo '=== Deploying to Kubernetes ==='
                bat '''
                kubectl apply -f k8s/backend-deployment.yaml
                kubectl apply -f k8s/frontend-deployment.yaml
                kubectl get pods
                '''
            }
        }

        stage('Cleanup') {
            steps {
                echo '=== Cleanup ==='
                bat '''
                REM Optionnel : supprimer cluster Kind
                REM kind delete cluster --name k8s-terraform
                '''
            }
        }
    }

    post {
        success {
            echo 'Pipeline finished successfully.'
        }
        failure {
            echo 'Pipeline failed. Check logs.'
        }
    }
}
