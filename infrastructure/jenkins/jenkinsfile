pipeline {
    agent any
    
    environment {
        PATH = "C:\\Program Files\\Docker\\Docker\\resources\\bin;C:\\ProgramData\\chocolatey\\bin;${env.PATH}"
        CLUSTER_NAME = 'k8s-terraform'
        BUILD_TAG = "${BUILD_NUMBER}"
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Checkout SCM') {
            steps {
                script {
                    // Nettoyer le workspace
                    bat '''
                        echo ==========================================
                        echo === CLEANING WORKSPACE ===
                        echo ==========================================
                        if exist ".git" (
                            echo Removing old .git directory...
                            rmdir /s /q .git 2>nul || echo Git directory removed
                        )
                    '''
                    
                    // Configurer Git
                    bat '''
                        echo ==========================================
                        echo === CONFIGURING GIT ===
                        echo ==========================================
                        git config --global http.postBuffer 524288000
                        git config --global http.maxRequestBuffer 100M
                        git config --global core.compression 0
                        git config --global http.lowSpeedLimit 0
                        git config --global http.lowSpeedTime 999999
                        
                        echo Current Git configuration:
                        git config --list | findstr http
                    '''
                    
                    // Méthode 1 : Essayer le checkout Jenkins (shallow clone)
                    def checkoutSuccess = false
                    
                    try {
                        echo "Attempting Jenkins checkout with shallow clone..."
                        retry(2) {
                            timeout(time: 10, unit: 'MINUTES') {
                                checkout([
                                    $class: 'GitSCM',
                                    branches: [[name: '*/main']],
                                    extensions: [
                                        [$class: 'CloneOption', 
                                         depth: 1, 
                                         noTags: true, 
                                         shallow: true,
                                         timeout: 30]
                                    ],
                                    userRemoteConfigs: [[
                                        url: 'https://github.com/zineb-chgari/traffic_optimizer.git'
                                    ]]
                                ])
                            }
                        }
                        checkoutSuccess = true
                        echo "✓ Jenkins checkout successful!"
                    } catch (Exception e) {
                        echo "⚠ Jenkins checkout failed: ${e.message}"
                        echo "Attempting manual clone as fallback..."
                    }
                    
                    // Méthode 2 : Si échec, clone manuel
                    if (!checkoutSuccess) {
                        bat '''
                            echo ==========================================
                            echo === MANUAL GIT CLONE ===
                            echo ==========================================
                            
                            REM Initialiser le repo
                            git init
                            git remote add origin https://github.com/zineb-chgari/traffic_optimizer.git
                            
                            REM Fetch shallow
                            echo Fetching repository (shallow clone)...
                            git fetch --depth 1 origin main
                            
                            REM Checkout
                            echo Checking out main branch...
                            git checkout main
                            
                            echo ✓ Manual clone completed successfully!
                        '''
                        checkoutSuccess = true
                    }
                    
                    // Vérification finale
                    bat '''
                        echo ==========================================
                        echo === VERIFYING CHECKOUT ===
                        echo ==========================================
                        echo Files in workspace:
                        dir /b
                        echo.
                        
                        if exist "backend" (
                            echo ✓ backend directory found
                        ) else (
                            echo ✗ backend directory NOT found!
                            exit /b 1
                        )
                        
                        if exist "frontend" (
                            echo ✓ frontend directory found
                        ) else (
                            echo ✗ frontend directory NOT found!
                            exit /b 1
                        )
                        
                        if exist "infrastructure" (
                            echo ✓ infrastructure directory found
                        ) else (
                            echo ✗ infrastructure directory NOT found!
                            exit /b 1
                        )
                        
                        echo.
                        echo ✓ All required directories verified!
                    '''
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    // Récupérer TOUTES les clés API
                    try {
                        withCredentials([
                            string(credentialsId: 'tomtom-api-key', variable: 'TOMTOM_KEY'),
                            string(credentialsId: 'opencage-api-key', variable: 'OPENCAGE_KEY'),
                            string(credentialsId: 'ors-api-key', variable: 'ORS_KEY')
                        ]) {
                            env.TOMTOM_API_KEY = TOMTOM_KEY
                            env.OPENCAGE_API_KEY = OPENCAGE_KEY
                            env.ORS_API_KEY = ORS_KEY
                        }
                        echo "✓ All API Keys loaded from Jenkins credentials"
                    } catch (Exception e) {
                        // Fallback: utiliser les valeurs du .env
                        env.TOMTOM_API_KEY = 'Cjx7i2N9ESmF9Sq8Bw6QtZ4FRJkCQMLy'
                        env.OPENCAGE_API_KEY = '464eb4ad7e734a768928fd696b968ee4'
                        env.ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjIwNjAxYzVlZmFlNjQ1OGZiOTY3ODUxNDg3NTY2MjBlIiwiaCI6Im11cm11cjY0In0='
                        echo "⚠ WARNING: Jenkins credentials not found, using hardcoded API keys"
                    }
                }
            }
        }
        
        stage('Environment Check') {
            steps {
                script {
                    bat """
                        echo ==========================================
                        echo === ENVIRONMENT CHECK ===
                        echo ==========================================
                        echo PATH: %PATH%
                        echo.
                        echo Checking tools...
                        docker --version
                        kubectl version --client
                        terraform version
                        kind version
                        echo.
                        echo ✓ All tools verified successfully!
                    """
                }
            }
        }
        
        // ... (rest of your stages remain the same)
        
    }
    
    post {
        always {
            script {
                echo 'Pipeline execution completed - Cleaning up...'
                try {
                    bat 'docker system prune -f || exit 0'
                } catch (Exception e) {
                    echo "Cleanup skipped: ${e.message}"
                }
            }
        }
        
        success {
            script {
                echo ''
                echo '=========================================='
                echo '✓✓✓ PIPELINE SUCCEEDED ✓✓✓'
                echo '=========================================='
            }
        }
        
        failure {
            script {
                echo ''
                echo '=========================================='
                echo '✗✗✗ PIPELINE FAILED ✗✗✗'
                echo '=========================================='
                
                try {
                    bat '''
                        echo === DIAGNOSTICS ===
                        git config --list 2>nul || echo Cannot get git config
                        dir /b 2>nul || echo Cannot list files
                    '''
                } catch (Exception e) {
                    echo "Could not gather diagnostics"
                }
            }
        }
    }
}