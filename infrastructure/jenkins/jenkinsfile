pipeline {
    agent any

    environment {
        // Commit court pour tag Docker
        GIT_COMMIT = ''
        // Paramètres Docker Hub (à configurer plus tard)
        DOCKER_USER = credentials('docker-username') // Jenkins credential ID
        DOCKER_PASS = credentials('docker-password')
        FRONT_IMAGE = ''
        BACK_IMAGE = ''
    }

    stages {
        stage('Checkout SCM') {
            steps {
                echo "[INFO] Checkout code from Git"
                checkout scm
                script {
                    // Commit court pour tag
                    GIT_COMMIT = bat(script: '"C:\\Program Files\\Git\\cmd\\git.exe" rev-parse --short HEAD', returnStdout: true).trim()
                    FRONT_IMAGE = "traffic_front:${GIT_COMMIT}"
                    BACK_IMAGE = "traffic_back:${GIT_COMMIT}"
                    echo "[INFO] Current commit: ${GIT_COMMIT}"
                }
            }
        }

        stage('Check Git & Docker') {
            steps {
                bat '"C:\\Program Files\\Git\\cmd\\git.exe" --version'
                bat '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe" --version'
            }
        }

        stage('Build Frontend Docker') {
            steps {
                echo "[INFO] Building frontend Docker image..."
                bat "\"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe\" build -f frontend/Dockerfile -t ${FRONT_IMAGE} frontend"
            }
        }

        stage('Build Backend Docker') {
            steps {
                echo "[INFO] Building backend Docker image..."
                bat "\"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe\" build -f backend/Dockerfile -t ${BACK_IMAGE} backend"
            }
        }

        stage('Optional: Push Docker Images') {
            steps {
                echo "[INFO] Push Docker images (if registry configured)"
                script {
                    // Vérifie si les credentials Docker sont définis
                    if (DOCKER_USER && DOCKER_PASS) {
                        bat "\"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe\" login -u %DOCKER_USER% -p %DOCKER_PASS%"
                        bat "\"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe\" push ${FRONT_IMAGE}"
                        bat "\"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe\" push ${BACK_IMAGE}"
                    } else {
                        echo "[INFO] Docker credentials not configured. Skipping push."
                    }
                }
            }
        }
    }

    post {
        always {
            echo "[INFO] Cleaning up Docker..."
            bat '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe" system prune -f || exit 0'
        }
        success {
            echo "[SUCCESS] Pipeline finished successfully!"
        }
        failure {
            echo "[ERROR] Pipeline failed!"
        }
    }
}
