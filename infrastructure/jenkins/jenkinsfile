pipeline {
    agent any

    environment {
        PATH = "C:\\Program Files\\Docker\\Docker\\resources\\bin;C:\\ProgramData\\chocolatey\\bin;C:\\Windows\\System32;C:\\Windows;C:\\Windows\\System32\\WindowsPowerShell\\v1.0;C:\\Program Files\\Python313;C:\\Program Files\\Python313\\Scripts"
        BACKEND_IMAGE = "transport-backend"
        FRONTEND_IMAGE = "transport-frontend"
        IMAGE_TAG = "${BUILD_NUMBER}"
        CLUSTER_NAME = "k8s-terraform"
        KUBECONFIG = "${WORKSPACE}\\.kube\\config"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                checkout([$class: 'GitSCM', 
                          branches: [[name: '*/main']], 
                          userRemoteConfigs: [[url: 'https://github.com/zineb-chgari/traffic_optimizer.git']]])
            }
        }

        stage('Environment Check') {
            steps {
                bat '''
                echo === PATH CHECK ===
                echo %PATH%
                docker --version || echo Docker not found
                kubectl version --client || echo kubectl not found
                terraform version || echo Terraform not found
                kind version || echo Kind not found
                '''
            }
        }

        stage('Setup Kind Cluster') {
            steps {
                bat '''
                echo ========================================
                echo Checking Kind cluster status...
                echo ========================================
                
                REM Vérifier si le cluster existe
                kind get clusters | findstr /R /C:"^%CLUSTER_NAME%$" >nul 2>&1
                if errorlevel 1 (
                    echo [INFO] Cluster not found. Creating...
                    kind create cluster --name %CLUSTER_NAME% --config kind-config.yaml --wait 120s
                ) else (
                    echo [INFO] Cluster exists, reusing...
                )
                
                REM Générer le kubeconfig dans le workspace Jenkins
                kind get kubeconfig --name %CLUSTER_NAME% > %KUBECONFIG%
                
                echo ========================================
                echo Kind cluster setup completed
                echo ========================================
                '''
            }
        }

        stage('Build Docker Images') {
            steps {
                bat '''
                docker build -f backend\\Dockerfile -t %BACKEND_IMAGE%:latest -t %BACKEND_IMAGE%:%IMAGE_TAG% backend
                docker build -f frontend\\Dockerfile -t %FRONTEND_IMAGE%:latest -t %FRONTEND_IMAGE%:%IMAGE_TAG% frontend
                '''
            }
        }

        stage('Load Images to Kind') {
            steps {
                bat '''
                kind load docker-image %BACKEND_IMAGE%:latest --name %CLUSTER_NAME%
                kind load docker-image %FRONTEND_IMAGE%:latest --name %CLUSTER_NAME%
                '''
            }
        }

        stage('Terraform Deploy') {
            steps {
                dir('infrastructure\\Terraform') {
                    bat '''
                    echo ========================================
                    echo Deploying Kubernetes resources with Terraform
                    echo ========================================

                    REM Utiliser le kubeconfig généré
                    set KUBECONFIG=%WORKSPACE%\\.kube\\config

                    terraform init -input=false
                    terraform apply -auto-approve
                    '''
                }
            }
        }

        stage('Verify Pods') {
            steps {
                bat '''
                echo ========================================
                echo Waiting for pods to be ready...
                echo ========================================
                
                set KUBECONFIG=%WORKSPACE%\\.kube\\config

                REM Attendre que Redis, Backend et Frontend soient prêts
                kubectl wait --for=condition=Ready pod -l app=redis --timeout=180s
                kubectl wait --for=condition=Ready pod -l app=backend --timeout=180s
                kubectl wait --for=condition=Ready pod -l app=frontend --timeout=180s

                echo ========================================
                echo Pods status:
                kubectl get pods -A
                echo ========================================
                '''
            }
        }

        stage('Verify Cluster & Services') {
            steps {
                bat '''
                set KUBECONFIG=%WORKSPACE%\\.kube\\config
                kubectl get svc -A
                kubectl get nodes
                kubectl cluster-info
                '''
            }
        }
    }

    post {
        always {
            echo "Pipeline finished"
        }
        success {
            echo "Pipeline completed successfully! Your apps should be accessible."
            echo "Frontend NodePort: 30001"
            echo "Backend NodePort: 30002"
        }
        failure {
            echo "Pipeline failed. Debug info:"
            bat '''
            set KUBECONFIG=%WORKSPACE%\\.kube\\config
            kubectl get pods -A
            kubectl get svc -A
            kubectl describe pods -l app=backend
            kubectl describe pods -l app=frontend
            kubectl describe pods -l app=redis
            '''
        }
    }
}
