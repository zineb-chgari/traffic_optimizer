pipeline {
    agent any

    environment {
        // Chemins absolus sur Windows
        DOCKER_PATH = '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe"'
        KIND_PATH   = '"C:\\ProgramData\\chocolatey\\bin\\kind.exe"'
        KUBECTL    = '"C:\\ProgramData\\chocolatey\\bin\\kubectl.exe"'
        TERRAFORM  = '"C:\\ProgramData\\chocolatey\\bin\\terraform.exe"'
        BUILD_NUM  = "${BUILD_NUMBER}"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    userRemoteConfigs: [[
                        url: 'https://github.com/zineb-chgari/traffic_optimizer.git'
                    ]]
                ])
            }
        }

        stage('Environment Check') {
            steps {
                bat 'echo === ENV CHECK ==='
                bat '"C:\\Program Files\\Git\\cmd\\git.exe" --version'
                bat "${DOCKER_PATH} --version"
                bat "${KUBECTL} version --client"
                bat "${TERRAFORM} version"
                bat "${KIND_PATH} version"
            }
        }

        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat "${TERRAFORM} init -input=false"
                    bat "${TERRAFORM} validate"
                }
            }
        }

        stage('Build Backend Image') {
            steps {
                bat "${DOCKER_PATH} build -f backend/Dockerfile -t transport-backend:latest -t transport-backend:${BUILD_NUM} backend"
            }
        }

        stage('Build Frontend Image') {
            steps {
                bat "${DOCKER_PATH} build -f frontend/Dockerfile -t transport-frontend:latest -t transport-frontend:${BUILD_NUM} frontend"
            }
        }

        stage('Create or Update Kind Cluster') {
            steps {
                bat """
                set PATH=C:\\Program Files\\Docker\\Docker\\resources\\bin;%PATH%
                ${KIND_PATH} create cluster --name k8s-terraform --wait 60s
                """
            }
        }

        stage('Load Images to Kind') {
            steps {
                bat "${KIND_PATH} load docker-image transport-backend:${BUILD_NUM} --name k8s-terraform"
                bat "${KIND_PATH} load docker-image transport-frontend:${BUILD_NUM} --name k8s-terraform"
            }
        }

        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat "${TERRAFORM} apply -auto-approve"
                }
            }
        }

        stage('Wait for Pods') {
            steps {
                bat """
                ${KUBECTL} wait --for=condition=Ready pods --all --namespace=default --timeout=120s
                """
            }
        }

        stage('Verify Deployment') {
            steps {
                bat "${KUBECTL} get pods -n default"
                bat "${KUBECTL} get svc -n default"
            }
        }
    }

    post {
        always {
            echo 'Cleaning up...'
            bat "${DOCKER_PATH} system prune -f || exit 0"
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
