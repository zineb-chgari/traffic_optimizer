pipeline {
    agent any

    environment {
        DOCKER_REG = ''
        BACKEND_IMAGE = 'transport-backend'
        FRONTEND_IMAGE = 'transport-frontend'
        IMAGE_TAG = "${BUILD_NUMBER}"

        CLUSTER_NAME = 'k8s-terraform'
        KUBECONFIG = "${WORKSPACE}/.kube/config"
        KIND_PATH = 'C:\\ProgramData\\chocolatey\\bin\\kind.exe'
        DOCKER_PATH = 'C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe'
        TERRAFORM_PATH = 'C:\\ProgramData\\chocolatey\\bin\\terraform.exe'
        KUBECTL_PATH = 'C:\\ProgramData\\chocolatey\\bin\\kubectl.exe'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Environment Check') {
            steps {
                bat 'echo === ENV CHECK ==='
                bat '"%DOCKER_PATH%" --version'
                bat '"%KUBECTL_PATH%" version --client'
                bat '"%TERRAFORM_PATH%" version'
                bat '"%KIND_PATH%" version'
            }
        }

        stage('Validate Terraform') {
            steps {
                dir('infrastructure\\Terraform') {
                    bat '"%TERRAFORM_PATH%" init -input=false'
                    bat '"%TERRAFORM_PATH%" validate'
                }
            }
        }

        stage('Build Backend Image') {
            steps {
                bat '"%DOCKER_PATH%" build -f backend\\Dockerfile -t %BACKEND_IMAGE%:latest -t %BACKEND_IMAGE%:%BUILD_NUMBER% backend'
            }
        }

        stage('Build Frontend Image') {
            steps {
                bat '"%DOCKER_PATH%" build -f frontend\\Dockerfile -t %FRONTEND_IMAGE%:latest -t %FRONTEND_IMAGE%:%BUILD_NUMBER% frontend'
            }
        }

        stage('Create or Reuse Kind Cluster') {
            steps {
                bat """
                set PATH=%DOCKER_PATH%;%PATH%
                ${KIND_PATH} get clusters | findstr /R /C:"^%CLUSTER_NAME%\$"
                if errorlevel 1 (
                    echo Cluster %CLUSTER_NAME% does not exist. Creating...
                    ${KIND_PATH} create cluster --name %CLUSTER_NAME% --wait 60s
                ) else (
                    echo Cluster %CLUSTER_NAME% already exists, reusing it
                )
                """
            }
        }

        stage('Load Images to Kind') {
            steps {
                bat """
                ${KIND_PATH} load docker-image %BACKEND_IMAGE%:%BUILD_NUMBER% --name %CLUSTER_NAME%
                ${KIND_PATH} load docker-image %FRONTEND_IMAGE%:%BUILD_NUMBER% --name %CLUSTER_NAME%
                """
            }
        }

        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure\\Terraform') {
                    bat '"%TERRAFORM_PATH%" apply -auto-approve'
                }
            }
        }

        stage('Wait for Pods') {
            steps {
                bat """
                %KUBECTL_PATH% wait --for=condition=Ready pods --all --namespace=default --timeout=120s
                """
            }
        }

        stage('Verify Deployment') {
            steps {
                bat '%KUBECTL_PATH% get pods -A'
            }
        }
    }

    post {
        always {
            echo 'Cleaning up...'
            bat '"%DOCKER_PATH%" system prune -f || exit 0'
        }
    }
}
