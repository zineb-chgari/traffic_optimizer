pipeline {
    agent any
    
    environment {
        CLUSTER_NAME = 'k8s-terraform'
        BUILD_TAG = "${BUILD_NUMBER}"
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('Environment Check') {
            steps {
                bat '''
                    echo === PATH CHECK ===
                    echo %PATH%
                    docker --version || echo Docker not found
                    kubectl version --client || echo kubectl not found
                    terraform version || echo Terraform not found
                    kind version || echo Kind not found
                '''
            }
        }
        
        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat '''
                        terraform init -input=false
                        terraform validate
                    '''
                }
            }
        }
        
        stage('Pull Base Images') {
            steps {
                script {
                    retry(3) {
                        bat '''
                            echo Pulling base images...
                            docker pull node:20-alpine
                            docker pull nginx:alpine
                            docker pull redis:7-alpine
                        '''
                    }
                }
            }
        }
        
        stage('Build Backend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 10, unit: 'MINUTES') {
                            bat """
                                docker build -f backend\\Dockerfile ^
                                    -t transport-backend:latest ^
                                    -t transport-backend:${BUILD_TAG} ^
                                    backend
                            """
                        }
                    }
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 10, unit: 'MINUTES') {
                            bat """
                                docker build -f frontend\\Dockerfile ^
                                    -t transport-frontend:latest ^
                                    -t transport-frontend:${BUILD_TAG} ^
                                    frontend
                            """
                        }
                    }
                }
            }
        }
        
        stage('Setup Kind Cluster') {
            steps {
                script {
                    bat """
                        kind get clusters | findstr ${CLUSTER_NAME} && (
                            echo Cluster exists
                        ) || (
                            echo Creating cluster...
                            kind create cluster --name ${CLUSTER_NAME}
                        )
                    """
                }
            }
        }
        
        stage('Verify Cluster Connection') {
            steps {
                bat '''
                    kubectl cluster-info
                    kubectl get nodes
                '''
            }
        }
        
        stage('Load Images to Kind') {
            steps {
                script {
                    bat """
                        echo Loading images into Kind cluster...
                        kind load docker-image transport-backend:latest --name ${CLUSTER_NAME}
                        kind load docker-image transport-frontend:latest --name ${CLUSTER_NAME}
                        
                        echo Verifying images on nodes...
                        docker exec ${CLUSTER_NAME}-control-plane crisp images | findstr transport || echo Images loaded
                    """
                }
            }
        }
        
        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    script {
                        bat '''
                            echo Cleaning Terraform state if needed...
                            terraform state rm kubernetes_deployment_v1.backend 2>nul || echo No backend state
                            terraform state rm kubernetes_deployment_v1.frontend 2>nul || echo No frontend state
                            
                            echo Importing existing resources...
                            kubectl get deployment backend && terraform import kubernetes_deployment_v1.backend default/backend || echo No backend to import
                            kubectl get deployment frontend && terraform import kubernetes_deployment_v1.frontend default/frontend || echo No frontend to import
                            
                            echo Applying Terraform...
                            terraform apply -auto-approve
                        '''
                    }
                }
            }
        }
        
        stage('Wait for Pods') {
            steps {
                script {
                    timeout(time: 5, unit: 'MINUTES') {
                        bat '''
                            echo Waiting for pods to be ready...
                            kubectl wait --for=condition=ready pod -l app=backend --timeout=300s || echo Backend pods not ready
                            kubectl wait --for=condition=ready pod -l app=frontend --timeout=300s || echo Frontend pods not ready
                            kubectl wait --for=condition=ready pod -l app=redis --timeout=300s || echo Redis pod not ready
                        '''
                    }
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                bat '''
                    echo === Final Status ===
                    kubectl get pods -o wide
                    kubectl get svc
                    kubectl get deployment
                    
                    echo === Checking pod logs ===
                    kubectl logs -l app=backend --tail=20 --all-containers=true || echo No backend logs
                    kubectl logs -l app=frontend --tail=20 --all-containers=true || echo No frontend logs
                '''
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed'
            bat 'docker system prune -f || exit 0'
        }
        
        success {
            echo '=========================================='
            echo '✓ Pipeline succeeded'
            echo '=========================================='
            bat '''
                echo Access your application:
                echo Frontend: kubectl port-forward service/frontend-service 8080:80
                echo Backend: kubectl port-forward service/backend-service 3000:3000
            '''
        }
        
        failure {
            echo '=========================================='
            echo '✗ Pipeline failed'
            echo '=========================================='
            bat '''
                echo --- Debugging Information ---
                echo.
                echo Current Context:
                kubectl config current-context || echo Cannot get context
                echo.
                echo Cluster Info:
                kubectl cluster-info || echo Cannot get cluster info
                echo.
                echo All Pods:
                kubectl get pods --all-namespaces || echo Cannot get pods
                echo.
                echo Events:
                kubectl get events --sort-by=.metadata.creationTimestamp --all-namespaces || echo Cannot get events
            '''
        }
    }
}