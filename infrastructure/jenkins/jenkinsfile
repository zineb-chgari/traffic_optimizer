pipeline {
    agent any
    
    environment {
        PATH = "C:\\Program Files\\Docker\\Docker\\resources\\bin;C:\\ProgramData\\chocolatey\\bin;${env.PATH}"
        CLUSTER_NAME = 'k8s-terraform'
        BUILD_TAG = "${BUILD_NUMBER}"
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Setup Environment') {
            steps {
                script {
                    // Récupérer la clé TomTom avec gestion d'erreur
                    try {
                        withCredentials([string(credentialsId: 'tomtom-api-key', variable: 'TOMTOM_KEY')]) {
                            env.TOMTOM_API_KEY = TOMTOM_KEY
                        }
                        echo "✓ TomTom API Key loaded from credentials"
                    } catch (Exception e) {
                        env.TOMTOM_API_KEY = 'YOUR_TOMTOM_API_KEY_HERE'
                        echo "⚠ WARNING: TomTom credential not found, using placeholder"
                        echo "Please create credential 'tomtom-api-key' in Jenkins"
                    }
                }
            }
        }
        
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('Environment Check') {
            steps {
                script {
                    bat """
                        echo ==========================================
                        echo === ENVIRONMENT CHECK ===
                        echo ==========================================
                        echo PATH: %PATH%
                        echo.
                        echo Checking tools...
                        docker --version
                        kubectl version --client
                        terraform version
                        kind version
                        echo.
                        echo Checking TomTom API Key...
                        if "${env.TOMTOM_API_KEY}"=="YOUR_TOMTOM_API_KEY_HERE" (
                            echo WARNING: TomTom API Key not configured properly!
                            echo Please create credential 'tomtom-api-key' in Jenkins
                        ) else (
                            echo TomTom API Key configured ✓
                        )
                        echo.
                        echo All tools found successfully!
                    """
                }
            }
        }
        
        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat '''
                        terraform init -input=false
                        terraform validate
                    '''
                }
            }
        }
        
        stage('Pull Base Images') {
            steps {
                script {
                    retry(3) {
                        bat '''
                            echo ==========================================
                            echo === PULLING BASE IMAGES ===
                            echo ==========================================
                            echo Pulling node:20-alpine...
                            docker pull node:20-alpine
                            
                            echo.
                            echo Pulling nginx:alpine...
                            docker pull nginx:alpine
                            
                            echo.
                            echo Pulling Redis image with amd64 platform...
                            docker pull --platform linux/amd64 redis:7-alpine
                            
                            echo.
                            echo Verifying pulled images...
                            docker images | findstr "node.*20-alpine"
                            docker images | findstr "nginx.*alpine"
                            docker images | findstr "redis.*7-alpine"
                            
                            echo.
                            echo All base images pulled successfully!
                        '''
                    }
                }
            }
        }
        
        stage('Build Backend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 10, unit: 'MINUTES') {
                            bat """
                                echo ==========================================
                                echo === BUILDING BACKEND IMAGE ===
                                echo ==========================================
                                docker build -f backend\\Dockerfile ^
                                    --build-arg TOMTOM_API_KEY=${env.TOMTOM_API_KEY} ^
                                    -t transport-backend:latest ^
                                    -t transport-backend:${BUILD_TAG} ^
                                    backend
                                
                                echo.
                                echo Backend image built successfully!
                            """
                        }
                    }
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 20, unit: 'MINUTES') {
                            bat """
                                echo ==========================================
                                echo === BUILDING FRONTEND IMAGE ===
                                echo ==========================================
                                docker build -f frontend\\Dockerfile ^
                                    --build-arg NODE_OPTIONS=--max-old-space-size=4096 ^
                                    --build-arg TOMTOM_API_KEY=${env.TOMTOM_API_KEY} ^
                                    -t transport-frontend:latest ^
                                    -t transport-frontend:${BUILD_TAG} ^
                                    frontend
                                
                                echo.
                                echo Frontend image built successfully!
                            """
                        }
                    }
                }
            }
        }
        
        stage('Cleanup Old Cluster') {
            steps {
                bat """
                    echo ==========================================
                    echo === CLEANING UP OLD CLUSTER ===
                    echo ==========================================
                    
                    echo Deleting existing cluster if present...
                    kind delete cluster --name ${CLUSTER_NAME} 2>nul || echo No existing cluster to delete
                    
                    echo Waiting for cleanup to complete...
                    ping 127.0.0.1 -n 3 >nul
                    
                    echo Cleanup complete!
                """
            }
        }
        
        stage('Setup Kind Cluster') {
            steps {
                bat """
                    echo ==========================================
                    echo === CREATING KIND CLUSTER ===
                    echo ==========================================
                    
                    echo Creating fresh cluster ${CLUSTER_NAME}...
                    kind create cluster --name ${CLUSTER_NAME}
                    
                    echo.
                    echo Waiting for cluster to be fully ready...
                    
                    :wait_loop
                    kubectl get nodes | findstr "Ready" | findstr /V "NotReady" >nul 2>&1
                    if errorlevel 1 (
                        echo Node not ready yet, waiting 5 seconds...
                        ping 127.0.0.1 -n 6 >nul
                        goto wait_loop
                    )
                    
                    echo.
                    echo Node is ready! Waiting for system pods...
                    kubectl wait --for=condition=ready pod -l k8s-app=kube-dns -n kube-system --timeout=180s
                    
                    echo.
                    echo === CLUSTER IS FULLY OPERATIONAL ===
                    kubectl get nodes
                    kubectl get pods -n kube-system
                """
            }
        }
        
        stage('Create TomTom Secret') {
            steps {
                script {
                    bat """
                        echo ==========================================
                        echo === CREATING TOMTOM API SECRET ===
                        echo ==========================================
                        
                        echo Creating Kubernetes secret for TomTom API Key...
                        kubectl create secret generic tomtom-api-secret ^
                            --from-literal=TOMTOM_API_KEY=${env.TOMTOM_API_KEY} ^
                            --dry-run=client -o yaml | kubectl apply -f -
                        
                        echo.
                        echo Secret created successfully!
                        kubectl get secret tomtom-api-secret
                    """
                }
            }
        }
        
        stage('Verify Cluster Connection') {
            steps {
                bat '''
                    echo ==========================================
                    echo === VERIFYING CLUSTER CONNECTION ===
                    echo ==========================================
                    
                    echo Cluster Info:
                    kubectl cluster-info
                    
                    echo.
                    echo Nodes:
                    kubectl get nodes -o wide
                    
                    echo.
                    echo Namespaces:
                    kubectl get namespaces
                    
                    echo.
                    echo System Pods:
                    kubectl get pods -n kube-system
                    
                    echo.
                    echo Secrets:
                    kubectl get secrets
                    
                    echo.
                    echo Cluster verification complete!
                '''
            }
        }
        
        stage('Load Images to Kind') {
            steps {
                bat """
                    echo ==========================================
                    echo === LOADING IMAGES TO KIND CLUSTER ===
                    echo ==========================================
                    
                    echo Loading backend image...
                    kind load docker-image transport-backend:latest --name ${CLUSTER_NAME}
                    if errorlevel 1 (
                        echo ERROR: Failed to load backend image!
                        exit /b 1
                    )
                    echo Backend image loaded successfully!
                    
                    echo.
                    echo Loading frontend image...
                    kind load docker-image transport-frontend:latest --name ${CLUSTER_NAME}
                    if errorlevel 1 (
                        echo ERROR: Failed to load frontend image!
                        exit /b 1
                    )
                    echo Frontend image loaded successfully!
                    
                    echo.
                    echo Loading Redis image with workaround...
                    docker save redis:7-alpine | docker exec -i ${CLUSTER_NAME}-control-plane ctr --namespace=k8s.io images import --all-platforms=false --base-name docker.io/library/redis:7-alpine -
                    if errorlevel 1 (
                        echo Trying alternative tar-based method...
                        docker save redis:7-alpine -o %TEMP%\\redis-temp.tar
                        docker cp %TEMP%\\redis-temp.tar ${CLUSTER_NAME}-control-plane:/tmp/redis.tar
                        docker exec ${CLUSTER_NAME}-control-plane ctr --namespace=k8s.io images import --all-platforms=false /tmp/redis.tar
                        docker exec ${CLUSTER_NAME}-control-plane rm /tmp/redis.tar
                        del %TEMP%\\redis-temp.tar
                        if errorlevel 1 (
                            echo ERROR: All methods failed to load Redis image!
                            exit /b 1
                        )
                    )
                    echo Redis image loaded successfully!
                    
                    echo.
                    echo === VERIFYING LOADED IMAGES ===
                    docker exec ${CLUSTER_NAME}-control-plane crictl images | findstr transport
                    docker exec ${CLUSTER_NAME}-control-plane crictl images | findstr redis
                    
                    echo.
                    echo Verification: Checking if Redis image is available...
                    docker exec ${CLUSTER_NAME}-control-plane crictl images | findstr redis >nul
                    if errorlevel 1 (
                        echo ERROR: Redis image not found in Kind cluster!
                        echo Available images:
                        docker exec ${CLUSTER_NAME}-control-plane crictl images
                        exit /b 1
                    )
                    
                    echo.
                    echo ✓ All images loaded and verified successfully!
                """
            }
        }
        
        stage('Pre-Deploy Diagnostics') {
            steps {
                bat '''
                    echo ==========================================
                    echo === PRE-DEPLOYMENT DIAGNOSTICS ===
                    echo ==========================================
                    
                    echo Available images in Kind cluster:
                    docker exec k8s-terraform-control-plane crictl images
                    
                    echo.
                    echo Cluster resources:
                    kubectl top nodes 2>nul || echo "Metrics server not available"
                    
                    echo.
                    echo Node details:
                    kubectl describe node k8s-terraform-control-plane | findstr "Allocatable"
                    
                    echo.
                    echo Current events:
                    kubectl get events --all-namespaces --sort-by=.metadata.creationTimestamp | findstr /V "Normal" || echo "No warning events"
                    
                    echo.
                    echo Secrets available:
                    kubectl get secrets
                '''
            }
        }
        
        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    script {
                        bat """
                            echo ==========================================
                            echo === DEPLOYING WITH TERRAFORM ===
                            echo ==========================================
                            
                            echo Setting Terraform variables...
                            set TF_VAR_tomtom_api_key=${env.TOMTOM_API_KEY}
                            
                            echo Applying Terraform configuration...
                            terraform apply -auto-approve
                            
                            echo.
                            echo Terraform deployment initiated!
                        """
                    }
                }
            }
        }
        
        stage('Wait for Deployments') {
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    bat '''
                        echo ==========================================
                        echo === WAITING FOR DEPLOYMENTS ===
                        echo ==========================================
                        
                        echo Waiting for Redis deployment...
                        kubectl rollout status deployment/redis --timeout=300s || (
                            echo WARNING: Redis deployment timeout!
                            kubectl get pods -l app=redis
                            kubectl describe pods -l app=redis
                        )
                        
                        echo.
                        echo Waiting for Backend deployment...
                        kubectl rollout status deployment/backend --timeout=300s || (
                            echo WARNING: Backend deployment timeout!
                            kubectl get pods -l app=backend
                            kubectl describe pods -l app=backend
                        )
                        
                        echo.
                        echo Waiting for Frontend deployment...
                        kubectl rollout status deployment/frontend --timeout=300s || (
                            echo WARNING: Frontend deployment timeout!
                            kubectl get pods -l app=frontend
                            kubectl describe pods -l app=frontend
                        )
                        
                        echo.
                        echo === DEPLOYMENT STATUS ===
                        kubectl get deployments
                        kubectl get pods
                    '''
                }
            }
        }
        
        stage('Wait for Pods Ready') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    bat '''
                        echo ==========================================
                        echo === WAITING FOR PODS TO BE READY ===
                        echo ==========================================
                        
                        echo Waiting for Redis pod...
                        kubectl wait --for=condition=ready pod -l app=redis --timeout=180s || echo Redis pod not ready yet
                        
                        echo.
                        echo Waiting for Backend pods...
                        kubectl wait --for=condition=ready pod -l app=backend --timeout=180s || echo Backend pods not ready yet
                        
                        echo.
                        echo Waiting for Frontend pods...
                        kubectl wait --for=condition=ready pod -l app=frontend --timeout=180s || echo Frontend pods not ready yet
                        
                        echo.
                        echo === CURRENT POD STATUS ===
                        kubectl get pods -o wide
                    '''
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                bat '''
                    echo ==========================================
                    echo === DEPLOYMENT VERIFICATION ===
                    echo ==========================================
                    
                    echo.
                    echo === PODS STATUS ===
                    kubectl get pods -o wide
                    
                    echo.
                    echo === SERVICES ===
                    kubectl get svc
                    
                    echo.
                    echo === DEPLOYMENTS ===
                    kubectl get deployment
                    
                    echo.
                    echo === ENDPOINTS ===
                    kubectl get endpoints
                    
                    echo.
                    echo === SECRETS ===
                    kubectl get secrets
                    
                    echo.
                    echo ==========================================
                    echo === POD LOGS SUMMARY ===
                    echo ==========================================
                    
                    echo.
                    echo === Redis Logs (last 20 lines) ===
                    kubectl logs -l app=redis --tail=20 --all-containers=true 2>nul || echo No Redis logs available yet
                    
                    echo.
                    echo === Backend Logs (last 30 lines) ===
                    kubectl logs -l app=backend --tail=30 --all-containers=true 2>nul || echo No Backend logs available yet
                    
                    echo.
                    echo === Frontend Logs (last 20 lines) ===
                    kubectl logs -l app=frontend --tail=20 --all-containers=true 2>nul || echo No Frontend logs available yet
                    
                    echo.
                    echo ==========================================
                    echo === HEALTH CHECKS ===
                    echo ==========================================
                    
                    echo Testing Redis connectivity...
                    kubectl exec -it deployment/redis -- redis-cli ping 2>nul || echo Redis not responding
                    
                    echo.
                    echo Testing Backend health endpoint...
                    kubectl exec -it deployment/backend -- wget -q -O- http://localhost:3000/health 2>nul || echo Backend health check failed
                    
                    echo.
                    echo Checking TomTom API configuration in backend...
                    kubectl exec -it deployment/backend -- printenv | findstr TOMTOM 2>nul || echo TomTom env var check failed
                '''
            }
        }
        
        stage('Final Status Report') {
            steps {
                bat '''
                    echo.
                    echo ==========================================
                    echo === FINAL DEPLOYMENT STATUS ===
                    echo ==========================================
                    
                    echo.
                    echo Checking all pods status...
                    kubectl get pods --all-namespaces
                    
                    echo.
                    echo Checking deployments...
                    kubectl get deployments
                    
                    echo.
                    echo Checking services...
                    kubectl get svc
                    
                    echo.
                    echo Recent events (errors only):
                    kubectl get events --all-namespaces --field-selector type!=Normal --sort-by=.metadata.creationTimestamp | findstr /V "LAST" || echo No error events found
                    
                    echo.
                    echo ==========================================
                '''
            }
        }
        
        stage('Save Deployment Info') {
            steps {
                script {
                    // Sauvegarder les informations de déploiement pour le post-processing
                    bat '''
                        echo Saving deployment information...
                        kubectl get svc > deployment-services.txt 2>&1 || echo "Could not save services info"
                        kubectl get pods -o wide > deployment-pods.txt 2>&1 || echo "Could not save pods info"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'Pipeline execution completed - Cleaning up...'
                bat 'docker system prune -f || exit 0'
            }
        }
        
        success {
            script {
                echo ''
                echo '=========================================='
                echo '✓✓✓ PIPELINE SUCCEEDED ✓✓✓'
                echo '=========================================='
                echo ''
                echo 'Your application has been successfully deployed!'
                echo ''
                echo 'To access the services, open a NEW terminal and run:'
                echo ''
                echo 'FOR FRONTEND:'
                echo '  kubectl port-forward service/frontend-service 8080:80'
                echo '  Then open: http://localhost:8080'
                echo ''
                echo 'FOR BACKEND:'
                echo '  kubectl port-forward service/backend-service 3000:3000'
                echo '  Then open: http://localhost:3000'
                echo ''
                echo '=========================================='
                
                // Essayer d'afficher les infos, mais ne pas échouer si kubectl n'est plus accessible
                script {
                    try {
                        bat '''
                            kubectl get svc 2>nul || type deployment-services.txt 2>nul || echo "Service info not available"
                            echo.
                            kubectl get pods -o wide 2>nul || type deployment-pods.txt 2>nul || echo "Pod info not available"
                        '''
                    } catch (Exception e) {
                        echo "Note: Could not fetch live cluster info (this is normal)"
                        echo "Deployment was successful!"
                    }
                }
            }
        }
        
        failure {
            script {
                echo ''
                echo '=========================================='
                echo '✗✗✗ PIPELINE FAILED ✗✗✗'
                echo '=========================================='
                
                // Diagnostics en cas d'échec
                script {
                    try {
                        bat '''
                            echo === FAILURE DIAGNOSTICS ===
                            kubectl config get-contexts 2>nul || echo Cannot get contexts
                            kubectl get pods --all-namespaces -o wide 2>nul || echo Cannot get pods
                            docker exec k8s-terraform-control-plane crictl images 2>nul || echo Cannot access cluster
                            docker images | findstr "transport redis" || echo No images found
                            echo.
                            echo Check the logs above for details
                        '''
                    } catch (Exception e) {
                        echo "Could not gather diagnostics - check earlier stages for errors"
                    }
                }
            }
        }
    }
}