pipeline {
    agent any
    
    environment {
        PATH = "C:\\Program Files\\Docker\\Docker\\resources\\bin;C:\\ProgramData\\chocolatey\\bin;${env.PATH}"
        CLUSTER_NAME = 'k8s-terraform'
        BUILD_TAG = "${BUILD_NUMBER}"
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('Environment Check') {
            steps {
                bat '''
                    echo ==========================================
                    echo === ENVIRONMENT CHECK ===
                    echo ==========================================
                    echo PATH: %PATH%
                    echo.
                    echo Checking tools...
                    docker --version
                    kubectl version --client
                    terraform version
                    kind version
                    echo.
                    echo All tools found successfully!
                '''
            }
        }
        
        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat '''
                        terraform init -input=false
                        terraform validate
                    '''
                }
            }
        }
        
        stage('Pull Base Images') {
            steps {
                script {
                    retry(3) {
                        bat '''
                            echo Pulling base images...
                            docker pull node:20-alpine
                            docker pull nginx:alpine
                            docker pull redis:7-alpine
                        '''
                    }
                }
            }
        }
        
        stage('Build Backend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 10, unit: 'MINUTES') {
                            bat """
                                echo Building backend image...
                                docker build -f backend\\Dockerfile ^
                                    -t transport-backend:latest ^
                                    -t transport-backend:${BUILD_TAG} ^
                                    backend
                            """
                        }
                    }
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 10, unit: 'MINUTES') {
                            bat """
                                echo Building frontend image...
                                docker build -f frontend\\Dockerfile ^
                                    -t transport-frontend:latest ^
                                    -t transport-frontend:${BUILD_TAG} ^
                                    frontend
                            """
                        }
                    }
                }
            }
        }
        
        stage('Setup Kind Cluster') {
            steps {
                bat """
                    echo ==========================================
                    echo === SETTING UP KIND CLUSTER ===
                    echo ==========================================
                    
                    echo Deleting existing cluster if present...
                    kind delete cluster --name ${CLUSTER_NAME} 2>nul || echo No existing cluster to delete
                    
                    echo Creating fresh cluster ${CLUSTER_NAME}...
                    kind create cluster --name ${CLUSTER_NAME}
                    
                    echo Waiting for cluster to be fully ready...
                    echo This may take 1-2 minutes...
                    
                    :wait_loop
                    kubectl get nodes | findstr "Ready" | findstr /V "NotReady" >nul 2>&1
                    if errorlevel 1 (
                        echo Node not ready yet, waiting 5 seconds...
                        ping 127.0.0.1 -n 6 >nul
                        goto wait_loop
                    )
                    
                    echo Node is ready! Waiting for system pods...
                    kubectl wait --for=condition=ready pod -l k8s-app=kube-dns -n kube-system --timeout=180s
                    
                    echo Cluster is fully operational!
                    kubectl get nodes
                    kubectl get pods -n kube-system
                """
            }
        }
        
        stage('Verify Cluster Connection') {
            steps {
                bat '''
                    echo Verifying cluster connection...
                    kubectl cluster-info
                    kubectl get nodes -o wide
                    kubectl get namespaces
                '''
            }
        }
        
        stage('Load Images to Kind') {
            steps {
                bat """
                    echo ==========================================
                    echo === LOADING IMAGES TO KIND ===
                    echo ==========================================
                    
                    echo Loading backend image...
                    kind load docker-image transport-backend:latest --name ${CLUSTER_NAME}
                    
                    echo Loading frontend image...
                    kind load docker-image transport-frontend:latest --name ${CLUSTER_NAME}
                    
                    echo Verifying images are loaded...
                    docker exec ${CLUSTER_NAME}-control-plane crictl images | findstr transport
                    
                    echo Images loaded successfully!
                """
            }
        }
        
        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat '''
                        echo ==========================================
                        echo === DEPLOYING WITH TERRAFORM ===
                        echo ==========================================
                        
                        echo Applying Terraform configuration...
                        terraform apply -auto-approve
                        
                        echo Deployment complete!
                    '''
                }
            }
        }
        
        stage('Wait for Pods') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    bat '''
                        echo ==========================================
                        echo === WAITING FOR PODS ===
                        echo ==========================================
                        
                        echo Waiting for backend pods...
                        kubectl wait --for=condition=ready pod -l app=backend --timeout=300s || echo Backend pods still starting
                        
                        echo Waiting for frontend pods...
                        kubectl wait --for=condition=ready pod -l app=frontend --timeout=300s || echo Frontend pods still starting
                        
                        echo Waiting for redis pod...
                        kubectl wait --for=condition=ready pod -l app=redis --timeout=300s || echo Redis pod still starting
                        
                        echo Current pod status:
                        kubectl get pods
                    '''
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                bat '''
                    echo ==========================================
                    echo === DEPLOYMENT STATUS ===
                    echo ==========================================
                    
                    echo.
                    echo === Pods ===
                    kubectl get pods -o wide
                    
                    echo.
                    echo === Services ===
                    kubectl get svc
                    
                    echo.
                    echo === Deployments ===
                    kubectl get deployment
                    
                    echo.
                    echo === Backend Logs (last 10 lines) ===
                    kubectl logs -l app=backend --tail=10 --all-containers=true 2>nul || echo No backend logs yet
                    
                    echo.
                    echo === Frontend Logs (last 10 lines) ===
                    kubectl logs -l app=frontend --tail=10 --all-containers=true 2>nul || echo No frontend logs yet
                    
                    echo.
                    echo === Redis Logs (last 10 lines) ===
                    kubectl logs -l app=redis --tail=10 2>nul || echo No redis logs yet
                '''
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed'
            bat 'docker system prune -f || exit 0'
        }
        
        success {
            echo '=========================================='
            echo '✓ PIPELINE SUCCEEDED'
            echo '=========================================='
            bat '''
                echo.
                echo ==========================================
                echo === ACCESS YOUR APPLICATION ===
                echo ==========================================
                echo.
                echo To access your application, run:
                echo.
                echo   Frontend: kubectl port-forward service/frontend-service 8080:80
                echo   Backend:  kubectl port-forward service/backend-service 3000:3000
                echo.
                echo Then open in browser:
                echo   Frontend: http://localhost:8080
                echo   Backend:  http://localhost:3000
                echo.
                kubectl get svc
                echo.
            '''
        }
        
        failure {
            echo '=========================================='
            echo '✗ PIPELINE FAILED'
            echo '=========================================='
            bat '''
                echo.
                echo === DEBUGGING INFORMATION ===
                echo.
                echo Contexts:
                kubectl config get-contexts || echo No contexts available
                echo.
                echo Cluster Info:
                kubectl cluster-info || echo Cannot get cluster info
                echo.
                echo Pods:
                kubectl get pods --all-namespaces || echo Cannot get pods
                echo.
                echo Events:
                kubectl get events --sort-by=.metadata.creationTimestamp --all-namespaces | findstr /V "Normal" || echo Cannot get events
                echo.
                echo Docker Images:
                docker images | findstr transport
            '''
        }
    }
}