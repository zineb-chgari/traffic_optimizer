pipeline {
    agent any

    environment {
        // Configuration Docker
        DOCKER_REG = '' // Laisser vide pour Docker Hub local
        BACKEND_IMAGE = 'transport-backend'
        FRONTEND_IMAGE = 'transport-frontend'
        IMAGE_TAG = "${BUILD_NUMBER}"

        // Configuration Kubernetes
        CLUSTER_NAME = 'k8s-terraform'
        KUBECONFIG = "${WORKSPACE}/.kube/config"

        // Chemins
        GIT_EXEC = 'C:\\Program Files\\Git\\cmd\\git.exe'
        DOCKER_EXEC = 'C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe'

        // API Keys (Ã  configurer dans Jenkins Credentials)
        ORS_API_KEY = credentials('ors-api-key')
        TOMTOM_API_KEY = credentials('tomtom-api-key')
    }

    stages {
        stage('Checkout SCM') {
            steps {
                echo "[INFO] ðŸ” Checking out code from Git"
                script {
                    bat """
                        if exist .git (
                            "${GIT_EXEC}" pull origin main
                        ) else (
                            "${GIT_EXEC}" clone https://github.com/zineb-chgari/traffic_optimizer.git .
                        )
                    """
                    env.COMMIT_SHORT = bat(
                        script: "\"${GIT_EXEC}\" rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    echo "ðŸ“Œ Current commit: ${env.COMMIT_SHORT}"
                }
            }
        }

        stage('Environment Check') {
            steps {
                echo "[INFO] ðŸ”§ Checking environment"
                bat """
                    echo Git version:
                    "${GIT_EXEC}" --version

                    echo Docker version:
                    "${DOCKER_EXEC}" --version

                    echo Kubectl version:
                    kubectl version --client

                    echo Terraform version:
                    terraform version

                    echo Kind version:
                    kind version
                """
            }
        }

        stage('Validate Terraform') {
            steps {
                echo "[INFO] âœ… Validating Terraform configuration"
                dir('infrastructure/Terraform') {
                    bat """
                        terraform init
                        terraform validate
                    """
                }
            }
        }

        stage('Build Backend Image') {
            steps {
                echo "[INFO] ðŸ³ Building backend Docker image"
                bat """
                    "${DOCKER_EXEC}" build ^
                        -f backend/Dockerfile ^
                        -t ${BACKEND_IMAGE}:latest ^
                        -t ${BACKEND_IMAGE}:${IMAGE_TAG} ^
                        --build-arg BUILD_DATE=%date% ^
                        --build-arg VCS_REF=${COMMIT_SHORT} ^
                        .
                """
            }
        }

        stage('Build Frontend Image') {
            steps {
                echo "[INFO] ðŸ³ Building frontend Docker image"
                bat """
                    "${DOCKER_EXEC}" build ^
                        -f frontend/Dockerfile ^
                        -t ${FRONTEND_IMAGE}:latest ^
                        -t ${FRONTEND_IMAGE}:${IMAGE_TAG} ^
                        --build-arg VITE_API_URL=http://localhost:8000 ^
                        --build-arg BUILD_DATE=%date% ^
                        --build-arg VCS_REF=${COMMIT_SHORT} ^
                        .
                """
            }
        }

        stage('Create/Update Kind Cluster') {
            steps {
                echo "[INFO] ðŸŽ¯ Managing Kind cluster"
                script {
                    def clusterExists = bat(
                        script: "kind get clusters | findstr ${CLUSTER_NAME}",
                        returnStatus: true
                    ) == 0

                    if (clusterExists) {
                        echo "âœ… Cluster ${CLUSTER_NAME} already exists"
                    } else {
                        echo "ðŸ”¨ Creating cluster ${CLUSTER_NAME}"
                        bat """
                            kind create cluster ^
                                --name ${CLUSTER_NAME} ^
                                --config infrastructure/kind/cluster-config.yaml ^
                                --wait 5m
                        """
                    }
                    bat "kind export kubeconfig --name ${CLUSTER_NAME}"
                }
            }
        }

        stage('Load Images to Kind') {
            steps {
                echo "[INFO] ðŸ“¦ Loading Docker images to Kind cluster"
                bat """
                    kind load docker-image ${BACKEND_IMAGE}:latest --name ${CLUSTER_NAME}
                    kind load docker-image ${FRONTEND_IMAGE}:latest --name ${CLUSTER_NAME}
                """
            }
        }

        stage('Deploy with Terraform') {
            steps {
                echo "[INFO] ðŸš€ Deploying infrastructure with Terraform"
                dir('infrastructure/Terraform') {
                    bat """
                        terraform plan -out=tfplan
                        terraform apply -auto-approve tfplan
                        terraform output
                    """
                }
            }
        }

        stage('Wait for Deployments') {
            steps {
                echo "[INFO] â³ Waiting for pods to be ready"
                bat """
                    kubectl wait --for=condition=ready pod -l app=redis --timeout=120s
                    kubectl wait --for=condition=ready pod -l app=backend --timeout=120s
                    kubectl wait --for=condition=ready pod -l app=frontend --timeout=120s
                """
            }
        }

        stage('Verify Deployment') {
            steps {
                echo "[INFO] ðŸ” Verifying deployment"
                bat """
                    echo ========================================
                    kubectl get deployments
                    echo ========================================
                    kubectl get services
                    echo ========================================
                    kubectl get pods -o wide
                    echo ========================================
                    kubectl logs -l app=backend --tail=20
                """
            }
        }
    }

    post {
        always {
            node {
                withEnv(["DOCKER_EXEC=${DOCKER_EXEC}"]) {
                    echo "[INFO] ðŸ§¹ Cleaning up"
                    bat """
                        "${DOCKER_EXEC}" system prune -f || exit 0
                        if exist infrastructure\\Terraform\\tfplan del infrastructure\\Terraform\\tfplan
                    """
                }
            }
        }

        success {
            echo "[SUCCESS] âœ… Pipeline completed successfully!"
            script {
                def nodeIP = bat(
                    script: 'kubectl get nodes -o jsonpath="{.items[0].status.addresses[?(@.type==\\"InternalIP\\")].address}"',
                    returnStdout: true
                ).trim()
                currentBuild.description = """
                    Build: ${BUILD_NUMBER}
                    Commit: ${COMMIT_SHORT}
                    Frontend: http://${nodeIP}:30001
                    Backend: http://${nodeIP}:30002
                """
            }
        }

        failure {
            node {
                echo "[ERROR] âŒ Pipeline failed!"
                bat """
                    kubectl get pods > pod-status.log
                    kubectl describe pods >> pod-status.log
                    kubectl logs -l app=backend --tail=50 > backend-logs.log || exit 0
                    kubectl logs -l app=frontend --tail=50 > frontend-logs.log || exit 0
                """
                archiveArtifacts artifacts: '*.log', allowEmptyArchive: true
            }
        }
    }
}
