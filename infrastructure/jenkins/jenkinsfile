pipeline {
    agent any
    
    environment {
        PATH = "C:\\Program Files\\Docker\\Docker\\resources\\bin;C:\\ProgramData\\chocolatey\\bin;${env.PATH}"
        CLUSTER_NAME = 'k8s-terraform'
        BUILD_TAG = "${BUILD_NUMBER}"
        // Configuration TomTom API - avec valeur par défaut si credential absent
        TOMTOM_API_KEY = credentials('tomtom-api-key') ?: 'YOUR_TOMTOM_API_KEY_HERE'
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('Environment Check') {
            steps {
                bat '''
                    echo ==========================================
                    echo === ENVIRONMENT CHECK ===
                    echo ==========================================
                    echo PATH: %PATH%
                    echo.
                    echo Checking tools...
                    docker --version
                    kubectl version --client
                    terraform version
                    kind version
                    echo.
                    echo Checking TomTom API Key...
                    if "%TOMTOM_API_KEY%"=="YOUR_TOMTOM_API_KEY_HERE" (
                        echo WARNING: TomTom API Key not configured properly!
                        echo Please create credential 'tomtom-api-key' in Jenkins
                        echo Using placeholder value for now...
                    ) else (
                        echo TomTom API Key configured ✓
                    )
                    echo.
                    echo All tools found successfully!
                '''
            }
        }
        
        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat '''
                        terraform init -input=false
                        terraform validate
                    '''
                }
            }
        }
        
        stage('Pull Base Images') {
            steps {
                script {
                    retry(3) {
                        bat '''
                            echo ==========================================
                            echo === PULLING BASE IMAGES ===
                            echo ==========================================
                            echo Pulling node:20-alpine...
                            docker pull node:20-alpine
                            
                            echo.
                            echo Pulling nginx:alpine...
                            docker pull nginx:alpine
                            
                            echo.
                            echo Pulling Redis image with amd64 platform...
                            docker pull --platform linux/amd64 redis:7-alpine
                            
                            echo.
                            echo Verifying pulled images...
                            docker images | findstr "node.*20-alpine"
                            docker images | findstr "nginx.*alpine"
                            docker images | findstr "redis.*7-alpine"
                            
                            echo.
                            echo All base images pulled successfully!
                        '''
                    }
                }
            }
        }
        
        stage('Build Backend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 10, unit: 'MINUTES') {
                            bat """
                                echo ==========================================
                                echo === BUILDING BACKEND IMAGE ===
                                echo ==========================================
                                docker build -f backend\\Dockerfile ^
                                    --build-arg TOMTOM_API_KEY=%TOMTOM_API_KEY% ^
                                    -t transport-backend:latest ^
                                    -t transport-backend:${BUILD_TAG} ^
                                    backend
                                
                                echo.
                                echo Backend image built successfully!
                            """
                        }
                    }
                }
            }
        }
        
        stage('Build Frontend Image') {
            steps {
                script {
                    retry(2) {
                        timeout(time: 20, unit: 'MINUTES') {
                            bat """
                                echo ==========================================
                                echo === BUILDING FRONTEND IMAGE ===
                                echo ==========================================
                                docker build -f frontend\\Dockerfile ^
                                    --build-arg NODE_OPTIONS=--max-old-space-size=4096 ^
                                    --build-arg TOMTOM_API_KEY=%TOMTOM_API_KEY% ^
                                    -t transport-frontend:latest ^
                                    -t transport-frontend:${BUILD_TAG} ^
                                    frontend
                                
                                echo.
                                echo Frontend image built successfully!
                            """
                        }
                    }
                }
            }
        }
        
        stage('Cleanup Old Cluster') {
            steps {
                bat """
                    echo ==========================================
                    echo === CLEANING UP OLD CLUSTER ===
                    echo ==========================================
                    
                    echo Deleting existing cluster if present...
                    kind delete cluster --name ${CLUSTER_NAME} 2>nul || echo No existing cluster to delete
                    
                    echo Waiting for cleanup to complete...
                    ping 127.0.0.1 -n 3 >nul
                    
                    echo Cleanup complete!
                """
            }
        }
        
        stage('Setup Kind Cluster') {
            steps {
                bat """
                    echo ==========================================
                    echo === CREATING KIND CLUSTER ===
                    echo ==========================================
                    
                    echo Creating fresh cluster ${CLUSTER_NAME}...
                    kind create cluster --name ${CLUSTER_NAME}
                    
                    echo.
                    echo Waiting for cluster to be fully ready...
                    
                    :wait_loop
                    kubectl get nodes | findstr "Ready" | findstr /V "NotReady" >nul 2>&1
                    if errorlevel 1 (
                        echo Node not ready yet, waiting 5 seconds...
                        ping 127.0.0.1 -n 6 >nul
                        goto wait_loop
                    )
                    
                    echo.
                    echo Node is ready! Waiting for system pods...
                    kubectl wait --for=condition=ready pod -l k8s-app=kube-dns -n kube-system --timeout=180s
                    
                    echo.
                    echo === CLUSTER IS FULLY OPERATIONAL ===
                    kubectl get nodes
                    kubectl get pods -n kube-system
                """
            }
        }
        
        stage('Create TomTom Secret') {
            steps {
                bat """
                    echo ==========================================
                    echo === CREATING TOMTOM API SECRET ===
                    echo ==========================================
                    
                    echo Creating Kubernetes secret for TomTom API Key...
                    kubectl create secret generic tomtom-api-secret ^
                        --from-literal=TOMTOM_API_KEY=%TOMTOM_API_KEY% ^
                        --dry-run=client -o yaml | kubectl apply -f -
                    
                    echo.
                    echo Secret created successfully!
                    kubectl get secret tomtom-api-secret
                """
            }
        }
        
        stage('Load Images to Kind') {
            steps {
                bat """
                    echo ==========================================
                    echo === LOADING IMAGES TO KIND CLUSTER ===
                    echo ==========================================
                    
                    echo Loading backend image...
                    kind load docker-image transport-backend:latest --name ${CLUSTER_NAME}
                    echo Backend image loaded!
                    
                    echo.
                    echo Loading frontend image...
                    kind load docker-image transport-frontend:latest --name ${CLUSTER_NAME}
                    echo Frontend image loaded!
                    
                    echo.
                    echo Loading Redis image...
                    docker save redis:7-alpine | docker exec -i ${CLUSTER_NAME}-control-plane ctr --namespace=k8s.io images import --all-platforms=false --base-name docker.io/library/redis:7-alpine - 2>nul || (
                        echo Trying alternative method...
                        docker save redis:7-alpine -o %TEMP%\\redis-temp.tar
                        docker cp %TEMP%\\redis-temp.tar ${CLUSTER_NAME}-control-plane:/tmp/redis.tar
                        docker exec ${CLUSTER_NAME}-control-plane ctr --namespace=k8s.io images import --all-platforms=false /tmp/redis.tar
                        docker exec ${CLUSTER_NAME}-control-plane rm /tmp/redis.tar
                        del %TEMP%\\redis-temp.tar
                    )
                    echo Redis image loaded!
                    
                    echo.
                    echo === VERIFYING LOADED IMAGES ===
                    docker exec ${CLUSTER_NAME}-control-plane crictl images | findstr transport
                    docker exec ${CLUSTER_NAME}-control-plane crictl images | findstr redis
                """
            }
        }
        
        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat """
                        echo ==========================================
                        echo === DEPLOYING WITH TERRAFORM ===
                        echo ==========================================
                        
                        echo Setting Terraform variables...
                        set TF_VAR_tomtom_api_key=%TOMTOM_API_KEY%
                        
                        echo Applying Terraform configuration...
                        terraform apply -auto-approve
                        
                        echo.
                        echo Terraform deployment complete!
                    """
                }
            }
        }
        
        stage('Wait for Deployments') {
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    bat '''
                        echo ==========================================
                        echo === WAITING FOR DEPLOYMENTS ===
                        echo ==========================================
                        
                        kubectl rollout status deployment/redis --timeout=300s || echo Redis deployment issue
                        kubectl rollout status deployment/backend --timeout=300s || echo Backend deployment issue
                        kubectl rollout status deployment/frontend --timeout=300s || echo Frontend deployment issue
                        
                        echo.
                        echo === DEPLOYMENT STATUS ===
                        kubectl get deployments
                        kubectl get pods
                    '''
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                bat '''
                    echo ==========================================
                    echo === DEPLOYMENT VERIFICATION ===
                    echo ==========================================
                    
                    kubectl get pods -o wide
                    kubectl get svc
                    kubectl get deployment
                    
                    echo.
                    echo === TESTING CONNECTIONS ===
                    kubectl exec -it deployment/redis -- redis-cli ping 2>nul || echo Redis check pending
                    kubectl exec -it deployment/backend -- wget -q -O- http://localhost:3000/health 2>nul || echo Backend check pending
                '''
            }
        }
    }
    
    post {
        always {
            script {
                node {
                    echo 'Pipeline execution completed - Cleaning up...'
                    bat 'docker system prune -f || exit 0'
                }
            }
        }
        
        success {
            script {
                node {
                    echo ''
                    echo '=========================================='
                    echo '✓✓✓ PIPELINE SUCCEEDED ✓✓✓'
                    echo '=========================================='
                    bat '''
                        echo.
                        echo ==========================================
                        echo === APPLICATION ACCESS INSTRUCTIONS ===
                        echo ==========================================
                        echo.
                        echo To access the frontend:
                        echo   kubectl port-forward service/frontend-service 8080:80
                        echo   Then open: http://localhost:8080
                        echo.
                        echo To access the backend:
                        echo   kubectl port-forward service/backend-service 3000:3000
                        echo   Then open: http://localhost:3000
                        echo.
                        echo === DEPLOYED SERVICES ===
                        kubectl get svc
                        echo.
                        echo === RUNNING PODS ===
                        kubectl get pods -o wide
                    '''
                }
            }
        }
        
        failure {
            script {
                node {
                    echo ''
                    echo '=========================================='
                    echo '✗✗✗ PIPELINE FAILED ✗✗✗'
                    echo '=========================================='
                    bat '''
                        echo.
                        echo === FAILURE DIAGNOSTICS ===
                        kubectl get pods --all-namespaces -o wide || echo Cannot get pods
                        kubectl get events --all-namespaces --sort-by=.metadata.creationTimestamp || echo Cannot get events
                        
                        echo.
                        echo === POD LOGS ===
                        for /f "tokens=1" %%i in ('kubectl get pods -o name 2^>nul') do (
                            echo Logs for %%i
                            kubectl logs %%i --all-containers=true --tail=50 2>nul || echo No logs
                        )
                    '''
                }
            }
        }
    }
}