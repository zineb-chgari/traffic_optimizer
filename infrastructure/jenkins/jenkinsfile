pipeline {
    agent any

    environment {
        // Mettre ici les chemins exacts des exécutables sur ton système
        PATH = "C:\\Program Files\\Docker\\Docker\\resources\\bin;C:\\Program Files\\Terraform;C:\\Users\\TonUser\\kubectl;C:\\Users\\TonUser\\kind;%PATH%"
    }

    stages {

        stage('Verify Tools') {
            steps {
                bat 'echo === Verifying tools ==='
                bat 'docker --version || echo Docker not found'
                bat 'kubectl version --client || echo kubectl not found'
                bat 'terraform version || echo Terraform not found'
                bat 'kind version || echo Kind not found'
            }
        }

        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat 'terraform init -input=false'
                    bat 'terraform validate'
                }
            }
        }

        stage('Build Backend Image') {
            steps {
                bat 'docker build -f backend/Dockerfile -t transport-backend:latest -t transport-backend:7 backend'
            }
        }

        stage('Build Frontend Image') {
            steps {
                bat 'docker build -f frontend/Dockerfile -t transport-frontend:latest -t transport-frontend:7 frontend'
            }
        }

        stage('Setup Kind Cluster') {
            steps {
                bat """
                    echo Setting up Kind cluster...
                    kind delete cluster --name k8s-terraform-7 || echo Cluster not found
                    kind create cluster --name k8s-terraform-7
                """
            }
        }

        stage('Load Images to Kind') {
            steps {
                bat 'kind load docker-image transport-backend:latest --name k8s-terraform-7'
                bat 'kind load docker-image transport-frontend:latest --name k8s-terraform-7'
            }
        }

        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat 'kubectl config use-context kind-k8s-terraform-7'
                    bat 'terraform apply -auto-approve'
                }
            }
        }

        stage('Wait for Pods') {
            steps {
                // On attend que tous les pods soient prêts, mais on ne plante pas si aucun pod n'est trouvé
                bat 'kubectl wait --for=condition=Ready pod -l app=redis --timeout=300s || echo Redis pods not ready yet'
                bat 'kubectl wait --for=condition=Ready pod -l app=backend --timeout=300s || echo Backend pods not ready yet'
                bat 'kubectl wait --for=condition=Ready pod -l app=frontend --timeout=300s || echo Frontend pods not ready yet'
            }
        }

        stage('Verify Deployment') {
            steps {
                bat 'kubectl get pods'
                bat 'kubectl get svc'
            }
        }
    }

    post {
        always {
            echo 'Cleaning up Docker cache...'
            bat 'docker system prune -f || exit 0'
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed. Check logs above for errors.'
        }
    }
}
