stage('Setup Kind Cluster') {
    steps {
        script {
            timeout(time: 10, unit: 'MINUTES') {
                echo "=== Setting up Kind Cluster ==="

                // Supprime l'ancien cluster si présent
                bat """
                kind delete cluster --name ${CLUSTER_NAME} 2>nul || echo No previous cluster
                kubectl config delete-context kind-${CLUSTER_NAME} 2>nul || echo No previous context
                """

                // Tente de créer le cluster et capture la sortie
                def createOutput = bat(script: "kind create cluster --name ${CLUSTER_NAME} --wait 120s", returnStdout: true).trim()
                echo "Kind create cluster output:\n${createOutput}"

                // Vérifie si le cluster est prêt
                def kubectlOutput = bat(script: "kubectl cluster-info --context kind-${CLUSTER_NAME}", returnStatus: true)
                if (kubectlOutput != 0) {
                    error "❌ Kind cluster creation failed or kubectl cannot connect. Check Docker and kubeconfig!"
                } else {
                    echo "✅ Kind cluster is up and kubectl can connect"
                }

                // Export kubeconfig pour s'assurer que kubectl pointe sur le bon cluster
                bat "kind export kubeconfig --name ${CLUSTER_NAME}"
            }
        }
    }
}
