pipeline {
    agent any
    
    environment {
        // ===== Docker Registry =====
        DOCKER_REGISTRY = 'registry.example.com'
        DOCKER_CREDENTIALS = 'docker-registry-credentials'
        
        // ===== Application versions =====
        BACKEND_IMAGE = "${DOCKER_REGISTRY}/transport-backend"
        FRONTEND_IMAGE = "${DOCKER_REGISTRY}/transport-frontend"
        VERSION = "${env.BUILD_NUMBER}-${env.GIT_COMMIT?.take(7) ?: 'unknown'}"
        
        // ===== Kubernetes =====
        K8S_NAMESPACE = 'transport-optimizer'
        K8S_CREDENTIALS = 'kubeconfig'
        
        // ===== Security scanning =====
        TRIVY_VERSION = 'latest'
        SONAR_PROJECT_KEY = 'transport-optimizer'
        
        // ===== Notification =====
        SLACK_CHANNEL = '#devops-alerts'
        SLACK_CREDENTIALS = 'slack-webhook'
        
        // ===== Paths complets =====
        GIT_CMD = '"C:\\Program Files\\Git\\cmd\\git.exe"'
        DOCKER_CMD = '"C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe"'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 1, unit: 'HOURS')
        disableConcurrentBuilds()
    }
    
    stages {
        // ---------------------------
        stage('Check Git & Docker') {
            steps {
                bat "${GIT_CMD} --version"
                bat "${DOCKER_CMD} --version"
                bat 'echo %PATH%'
            }
        }
        
        // ---------------------------
        stage('Checkout') {
            steps {
                script {
                    echo "[INFO] Checking out code from Git..."
                    checkout scm
                    
                    env.GIT_COMMIT_MSG = bat(
                        script: "${GIT_CMD} log -1 --pretty=%B",
                        returnStdout: true
                    ).trim()
                    
                    env.GIT_AUTHOR = bat(
                        script: "${GIT_CMD} log -1 --pretty=%an",
                        returnStdout: true
                    ).trim()
                }
            }
        }
        
        // ---------------------------
        stage('Install Dependencies') {
            parallel {
                stage('Backend Dependencies') {
                    steps {
                        dir('backend') {
                            bat '''
                                echo "[INFO] Installing backend dependencies..."
                                npm ci
                            '''
                        }
                    }
                }
                stage('Frontend Dependencies') {
                    steps {
                        dir('frontend') {
                            bat '''
                                echo "[INFO] Installing frontend dependencies..."
                                npm ci
                            '''
                        }
                    }
                }
            }
        }
        
        // ---------------------------
        stage('Code Quality & Testing') {
            parallel {
                stage('Backend Tests') {
                    steps {
                        dir('backend') {
                            bat '''
                                echo "[INFO] Running backend tests..."
                                npm run test || exit 0
                                npm run test:coverage || exit 0
                            '''
                        }
                    }
                }
                stage('Frontend Tests') {
                    steps {
                        dir('frontend') {
                            bat '''
                                echo "[INFO] Running frontend tests..."
                                npm run test -- --coverage --watchAll=false || exit 0
                            '''
                        }
                    }
                }
                stage('Lint Backend') {
                    steps {
                        dir('backend') {
                            bat '''
                                echo "[INFO] Linting backend code..."
                                npm run lint || exit 0
                            '''
                        }
                    }
                }
                stage('Lint Frontend') {
                    steps {
                        dir('frontend') {
                            bat '''
                                echo "[INFO] Linting frontend code..."
                                npm run lint || exit 0
                            '''
                        }
                    }
                }
            }
        }
        
        // ---------------------------
        stage('SonarQube Analysis') {
            steps {
                script {
                    withSonarQubeEnv('SonarQube') {
                        bat """
                            echo "[INFO] Running SonarQube analysis..."
                            sonar-scanner ^
                                -Dsonar.projectKey=${SONAR_PROJECT_KEY} ^
                                -Dsonar.sources=. ^
                                -Dsonar.host.url=%SONAR_HOST_URL% ^
                                -Dsonar.login=%SONAR_AUTH_TOKEN%
                        """
                    }
                    
                    timeout(time: 5, unit: 'MINUTES') {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            echo "[WARN] Quality Gate failed: ${qg.status}"
                        }
                    }
                }
            }
        }
        
        // ---------------------------
        stage('Build Docker Images') {
            parallel {
                stage('Build Backend Image') {
                    steps {
                        dir('backend') {
                            script {
                                echo "[INFO] Building backend Docker image..."
                                bat "${DOCKER_CMD} build -t ${BACKEND_IMAGE}:${VERSION} ."
                                bat "${DOCKER_CMD} tag ${BACKEND_IMAGE}:${VERSION} ${BACKEND_IMAGE}:latest"
                            }
                        }
                    }
                }
                stage('Build Frontend Image') {
                    steps {
                        dir('frontend') {
                            script {
                                echo "[INFO] Building frontend Docker image..."
                                bat "${DOCKER_CMD} build -t ${FRONTEND_IMAGE}:${VERSION} ."
                                bat "${DOCKER_CMD} tag ${FRONTEND_IMAGE}:${VERSION} ${FRONTEND_IMAGE}:latest"
                            }
                        }
                    }
                }
            }
        }
        
        // ---------------------------
        stage('Security Scanning') {
            parallel {
                stage('Scan Backend Image') {
                    steps {
                        script {
                            echo "[INFO] Scanning backend image with Trivy..."
                            bat """
                                ${DOCKER_CMD} run --rm -v //var/run/docker.sock://var/run/docker.sock ^
                                    aquasec/trivy:${TRIVY_VERSION} image ^
                                    --severity HIGH,CRITICAL ^
                                    --exit-code 0 ^
                                    --no-progress ^
                                    ${BACKEND_IMAGE}:${VERSION}
                            """
                        }
                    }
                }
                stage('Scan Frontend Image') {
                    steps {
                        script {
                            echo "[INFO] Scanning frontend image with Trivy..."
                            bat """
                                ${DOCKER_CMD} run --rm -v //var/run/docker.sock://var/run/docker.sock ^
                                    aquasec/trivy:${TRIVY_VERSION} image ^
                                    --severity HIGH,CRITICAL ^
                                    --exit-code 0 ^
                                    --no-progress ^
                                    ${FRONTEND_IMAGE}:${VERSION}
                            """
                        }
                    }
                }
                stage('Dependency Check') {
                    steps {
                        dir('frontend') {
                            bat '''
                                echo "[INFO] Checking frontend dependencies for vulnerabilities..."
                                npm audit --audit-level=high || exit 0
                            '''
                        }
                    }
                }
            }
        }
        
        // ---------------------------
        stage('Push Docker Images') {
            when { branch 'main' }
            steps {
                script {
                    echo "[INFO] Pushing Docker images to registry..."
                    docker.withRegistry("https://${DOCKER_REGISTRY}", DOCKER_CREDENTIALS) {
                        bat "${DOCKER_CMD} push ${BACKEND_IMAGE}:${VERSION}"
                        bat "${DOCKER_CMD} push ${BACKEND_IMAGE}:latest"
                        bat "${DOCKER_CMD} push ${FRONTEND_IMAGE}:${VERSION}"
                        bat "${DOCKER_CMD} push ${FRONTEND_IMAGE}:latest"
                    }
                }
            }
        }
        
        // ---------------------------
        stage('Deploy to Staging') {
            when { branch 'develop' }
            steps {
                script {
                    echo "[INFO] Deploying to Staging..."
                    withKubeConfig([credentialsId: K8S_CREDENTIALS]) {
                        bat """
                            kubectl set image deployment/backend backend=${BACKEND_IMAGE}:${VERSION} -n ${K8S_NAMESPACE}-staging
                            kubectl set image deployment/frontend frontend=${FRONTEND_IMAGE}:${VERSION} -n ${K8S_NAMESPACE}-staging
                            kubectl rollout status deployment/backend -n ${K8S_NAMESPACE}-staging
                            kubectl rollout status deployment/frontend -n ${K8S_NAMESPACE}-staging
                        """
                    }
                }
            }
        }
        
        stage('Integration Tests') {
            when { branch 'develop' }
            steps {
                dir('.') {
                    bat '''
                        echo "[INFO] Running integration tests..."
                        timeout /t 30
                        npm run test:integration || exit 0
                    '''
                }
            }
        }
        
        // ---------------------------
        stage('Deploy to Production') {
            when { branch 'main' }
            steps {
                script {
                    input message: 'Deploy to Production?', ok: 'Deploy'
                    echo "[INFO] Deploying to Production..."
                    withKubeConfig([credentialsId: K8S_CREDENTIALS]) {
                        bat """
                            kubectl set image deployment/backend backend=${BACKEND_IMAGE}:${VERSION} -n ${K8S_NAMESPACE}
                            kubectl set image deployment/frontend frontend=${FRONTEND_IMAGE}:${VERSION} -n ${K8S_NAMESPACE}
                            kubectl rollout status deployment/backend -n ${K8S_NAMESPACE} --timeout=5m
                            kubectl rollout status deployment/frontend -n ${K8S_NAMESPACE} --timeout=5m
                            kubectl get pods -n ${K8S_NAMESPACE}
                        """
                    }
                }
            }
        }
        
        stage('Smoke Tests') {
            when { branch 'main' }
            steps {
                dir('.') {
                    bat '''
                        echo "[INFO] Running smoke tests..."
                        timeout /t 30
                        curl -f https://transport.example.com/health || exit 1
                        curl -f https://transport.example.com/api/health || exit 1
                    '''
                }
            }
        }
        
        stage('Performance Tests') {
            when { branch 'main' }
            steps {
                dir('.') {
                    bat '''
                        echo "[INFO] Running performance tests..."
                        k6 run --vus 10 --duration 30s tests/performance/load-test.js || exit 0
                    '''
                }
            }
        }
        
        stage('Terraform Apply') {
            when {
                branch 'main'
                changeset "infrastructure/terraform/**"
            }
            steps {
                dir('infrastructure/terraform') {
                    bat '''
                        echo "[INFO] Applying Terraform changes..."
                        terraform init
                        terraform plan -out=tfplan
                        terraform apply -auto-approve tfplan
                    '''
                }
            }
        }
        
        stage('Update Monitoring') {
            steps {
                dir('infrastructure/grafana') {
                    bat '''
                        echo "[INFO] Updating monitoring dashboards..."
                        curl -X POST https://grafana.example.com/api/dashboards/db ^
                            -H "Content-Type: application/json" ^
                            -d @grafana/dashboards/transport-optimizer.json
                    '''
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "[INFO] Pipeline completed successfully"
                slackSend(
                    channel: SLACK_CHANNEL,
                    color: 'good',
                    message: "[SUCCESS] Build #${env.BUILD_NUMBER} completed for ${env.JOB_NAME}"
                )
            }
        }
        failure {
            script {
                echo "[ERROR] Pipeline failed"
                slackSend(
                    channel: SLACK_CHANNEL,
                    color: 'danger',
                    message: "[FAILURE] Build #${env.BUILD_NUMBER} failed for ${env.JOB_NAME}"
                )
            }
        }
        always {
            bat """
                echo "[INFO] Cleaning up Docker..."
                ${DOCKER_CMD} system prune -f || exit 0
            """
            archiveArtifacts artifacts: '**/target/*.jar,**/build/**/*.js', allowEmptyArchive: true
            junit '**/test-results/**/*.xml'
        }
    }
}
