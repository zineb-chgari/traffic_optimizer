pipeline {
    agent any

    environment {
        CLUSTER_NAME = "k8s-terraform"
        KUBECONFIG = "${WORKSPACE}\\.kube\\config"
    }

    stages {

        stage('Declarative: Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Environment Check') {
            steps {
                bat '''
                echo === PATH CHECK ===
                echo %PATH%
                docker --version || echo Docker not found
                kubectl version --client || echo kubectl not found
                terraform version || echo Terraform not found
                kind version || echo Kind not found
                '''
            }
        }

        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat 'terraform init -input=false'
                    bat 'terraform validate'
                }
            }
        }

        stage('Build Backend Image') {
            steps {
                bat 'docker build -f backend/Dockerfile -t transport-backend:latest backend'
            }
        }

        stage('Build Frontend Image') {
            steps {
                bat 'docker build -f frontend/Dockerfile -t transport-frontend:latest frontend'
            }
        }

        stage('Setup Kind Cluster') {
            steps {
                bat '''
                @echo off
                echo ========================================
                echo Checking Kind cluster status...
                echo ========================================

                REM Vérifier si le cluster existe
                kind get clusters 2>nul | findstr /R /C:"^%CLUSTER_NAME%$" >nul 2>&1

                if errorlevel 1 (
                    echo [INFO] Cluster not found, creating...
                    kind create cluster --name %CLUSTER_NAME% --wait 120s
                    if errorlevel 1 (
                        echo [ERROR] Failed to create cluster
                        exit /b 1
                    )
                    echo [SUCCESS] Cluster created
                ) else (
                    echo [INFO] Cluster exists, reusing it
                )
                echo ========================================
                '''
            }
        }

        stage('Load Images to Kind') {
            steps {
                bat '''
                kind load docker-image transport-backend:latest --name %CLUSTER_NAME%
                kind load docker-image transport-frontend:latest --name %CLUSTER_NAME%
                kind load docker-image redis:7-alpine --name %CLUSTER_NAME%
                '''
            }
        }

        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat 'terraform apply -auto-approve'
                }
            }
        }

        stage('Wait for Pods') {
            steps {
                bat '''
                set KUBECONFIG=%KUBECONFIG%
                echo Waiting for pods to be ready...
                kubectl wait --for=condition=Ready pod -l app=backend --timeout=120s
                kubectl wait --for=condition=Ready pod -l app=frontend --timeout=120s
                kubectl wait --for=condition=Ready pod -l app=redis --timeout=120s
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                bat '''
                set KUBECONFIG=%KUBECONFIG%
                echo === BACKEND PODS ===
                kubectl get pods -l app=backend
                echo === FRONTEND PODS ===
                kubectl get pods -l app=frontend
                echo === REDIS PODS ===
                kubectl get pods -l app=redis
                '''
            }
        }
    }

    post {
        always {
            bat 'docker system prune -f || exit 0'
            bat '''
            set KUBECONFIG=%KUBECONFIG%
            echo Current Context:
            kubectl config current-context
            echo Cluster Info:
            kubectl cluster-info
            '''
        }

        success {
            echo "Pipeline succeeded ✅"
        }

        failure {
            echo "Pipeline failed ❌"
        }
    }
}
