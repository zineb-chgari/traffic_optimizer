pipeline {
    agent any

    environment {
        // Chemins explicites
        DOCKER_PATH = 'C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe'
        KUBECTL_PATH = 'C:\\ProgramData\\chocolatey\\bin\\kubectl.exe'
        TERRAFORM_PATH = 'C:\\ProgramData\\chocolatey\\bin\\terraform.exe'
        KIND_PATH = 'C:\\ProgramData\\chocolatey\\bin\\kind.exe'

        // Images
        BACKEND_IMAGE = 'transport-backend'
        FRONTEND_IMAGE = 'transport-frontend'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout([
                    $class: 'GitSCM', 
                    branches: [[name: '*/main']], 
                    userRemoteConfigs: [[url: 'https://github.com/zineb-chgari/traffic_optimizer.git']]
                ])
            }
        }

        stage('Environment Check') {
            steps {
                bat "echo === ENV CHECK ==="
                bat "\"${DOCKER_PATH}\" --version"
                bat "\"${KUBECTL_PATH}\" version --client"
                bat "\"${TERRAFORM_PATH}\" version"
                bat "\"${KIND_PATH}\" version"
            }
        }

        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat "\"${TERRAFORM_PATH}\" init -input=false"
                    bat "\"${TERRAFORM_PATH}\" validate"
                }
            }
        }

        stage('Build Backend Image') {
            steps {
                bat "\"${DOCKER_PATH}\" build -f backend/Dockerfile -t ${BACKEND_IMAGE}:latest -t ${BACKEND_IMAGE}:%BUILD_NUMBER% backend"
            }
        }

        stage('Build Frontend Image') {
            steps {
                bat "\"${DOCKER_PATH}\" build -f frontend/Dockerfile -t ${FRONTEND_IMAGE}:latest -t ${FRONTEND_IMAGE}:%BUILD_NUMBER% frontend"
            }
        }

        stage('Create or Update Kind Cluster') {
            steps {
                // Spécifier explicitement le Docker utilisé par Kind
                bat "SET DOCKER=%DOCKER_PATH% && \"${KIND_PATH}\" create cluster --name k8s-terraform --wait 60s"
            }
        }

        stage('Load Images to Kind') {
            steps {
                bat "\"${KIND_PATH}\" load docker-image ${BACKEND_IMAGE}:latest --name k8s-terraform"
                bat "\"${KIND_PATH}\" load docker-image ${FRONTEND_IMAGE}:latest --name k8s-terraform"
            }
        }

        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat "\"${TERRAFORM_PATH}\" apply -auto-approve"
                }
            }
        }

        stage('Wait for Pods') {
            steps {
                bat "\"${KUBECTL_PATH}\" wait --for=condition=ready pod -l app=transport-backend --timeout=120s"
                bat "\"${KUBECTL_PATH}\" wait --for=condition=ready pod -l app=transport-frontend --timeout=120s"
            }
        }

        stage('Verify Deployment') {
            steps {
                bat "\"${KUBECTL_PATH}\" get pods"
                bat "\"${KUBECTL_PATH}\" get svc"
            }
        }
    }

    post {
        always {
            echo 'Cleaning up...'
            bat "\"${DOCKER_PATH}\" system prune -f || exit 0"
        }

        success {
            echo 'Pipeline completed successfully!'
        }

        failure {
            echo 'Pipeline failed!'
        }
    }
}
