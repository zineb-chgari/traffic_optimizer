pipeline {
    agent any

    environment {
        // Versions / tags
        BACKEND_IMAGE  = "transport-backend"
        FRONTEND_IMAGE = "transport-frontend"
        IMAGE_TAG      = "${BUILD_NUMBER}"

        // Tools (paths Windows Jenkins)
        DOCKER     = "C:\\Program Files\\Docker\\Docker\\resources\\bin\\docker.exe"
        KUBECTL    = "C:\\ProgramData\\chocolatey\\bin\\kubectl.exe"
        TERRAFORM  = "C:\\ProgramData\\chocolatey\\bin\\terraform.exe"
        KIND       = "C:\\ProgramData\\chocolatey\\bin\\kind.exe"
        GIT        = "C:\\Program Files\\Git\\cmd\\git.exe"
    }

    stages {

        /* ========================================================= */
        stage('Checkout SCM') {
            steps {
                checkout scm
                bat """
                    "${GIT}" rev-parse --short HEAD
                """
            }
        }

        /* ========================================================= */
        stage('Environment Check (Non Blocking)') {
            steps {
                bat """
                    echo === ENV CHECK ===
                    "${GIT}" --version
                    "${DOCKER}" --version
                    "${KUBECTL}" version --client
                    "${TERRAFORM}" version
                    "${KIND}" version
                """
            }
        }

        /* ========================================================= */
        stage('Validate Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat """
                        "${TERRAFORM}" init -input=false
                        "${TERRAFORM}" validate
                    """
                }
            }
        }

        /* ========================================================= */
        stage('Build Backend Image') {
            steps {
                bat """
                    "${DOCKER}" build ^
                        -f backend/Dockerfile ^
                        -t %BACKEND_IMAGE%:latest ^
                        -t %BACKEND_IMAGE%:%IMAGE_TAG% ^
                        backend
                """
            }
        }

        /* ========================================================= */
        stage('Build Frontend Image') {
            steps {
                bat """
                    "${DOCKER}" build ^
                        -f frontend/Dockerfile ^
                        -t %FRONTEND_IMAGE%:latest ^
                        -t %FRONTEND_IMAGE%:%IMAGE_TAG% ^
                        frontend
                """
            }
        }

        /* ========================================================= */
        stage('Create or Update Kind Cluster') {
            steps {
                bat """
                    "${KIND}" get clusters | findstr traffic-cluster || ^
                    "${KIND}" create cluster --name traffic-cluster
                """
            }
        }

        /* ========================================================= */
        stage('Load Images to Kind') {
            steps {
                bat """
                    "${KIND}" load docker-image %BACKEND_IMAGE%:latest --name traffic-cluster
                    "${KIND}" load docker-image %FRONTEND_IMAGE%:latest --name traffic-cluster
                """
            }
        }

        /* ========================================================= */
        stage('Deploy with Terraform') {
            steps {
                dir('infrastructure/Terraform') {
                    bat """
                        "${TERRAFORM}" apply -auto-approve
                    """
                }
            }
        }

        /* ========================================================= */
        stage('Wait for Pods') {
            steps {
                bat """
                    "${KUBECTL}" get pods --all-namespaces
                """
            }
        }

        /* ========================================================= */
        stage('Verify Deployment') {
            steps {
                bat """
                    "${KUBECTL}" get svc
                """
            }
        }
    }

    post {
        always {
            bat """
                "${DOCKER}" system prune -f || exit 0
                "${KUBECTL}" get pods > pod-status.log 2>&1 || exit 0
            """
            archiveArtifacts artifacts: 'pod-status.log', allowEmptyArchive: true
        }
    }
}
